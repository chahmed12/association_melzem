<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Ø¥Ø­ØµØ§Ø¡Ø§Øª Ø§Ù„Ø£Ø¹Ø¶Ø§Ø¡ - Ø±Ø§Ø¨Ø·Ø© Ø§Ù„Ø·Ù„ÙŠØ¹Ø© Ø§Ù„Ø´Ø¨Ø§Ø¨ÙŠØ© Ù„Ø¨Ù„Ø¯ÙŠØ© Ù…Ù„Ø²Ù… ØªÙŠØ´Ø·</title>
    <link href="https://fonts.googleapis.com/css2?family=Cairo:wght@400;600;700;900&display=swap" rel="stylesheet">
    <style>
        :root {
            --green: #1a5c38;
            --green-light: #2e8b57;
            --green-soft: #e8f5ee;
            --gold: #c9a84c;
        }
        * { box-sizing: border-box; margin: 0; padding: 0; }
        body {
            font-family: 'Cairo', sans-serif;
            background: #f0f4f8;
            min-height: 100vh;
        }

        /* â”€â”€ HEADER â”€â”€ */
        .header {
            background: linear-gradient(135deg, #0d1f13, var(--green) 60%, var(--green-light));
            padding: 1rem 1.25rem;
            display: flex;
            align-items: center;
            justify-content: space-between;
            box-shadow: 0 4px 20px rgba(0,0,0,.3);
            position: relative;
        }
        .header::after {
            content: '';
            position: absolute;
            bottom: 0; left: 0; right: 0;
            height: 3px;
            background: linear-gradient(90deg, transparent, var(--gold), transparent);
        }
        .header-center { text-align: center; flex: 1; }
        .header-title {
            color: white;
            font-size: clamp(.95rem, 3vw, 1.3rem);
            font-weight: 900;
        }
        .header-sub { color: rgba(255,255,255,.6); font-size: .7rem; margin-top: .2rem; }
        .header-side {
            display: flex;
            align-items: center;
            gap: .5rem;
            min-width: 90px;
        }
        .back-btn {
            background: rgba(255,255,255,.15);
            border: 1px solid rgba(255,255,255,.25);
            color: white;
            padding: .4rem .8rem;
            border-radius: 8px;
            text-decoration: none;
            font-size: .8rem;
            font-family: 'Cairo', sans-serif;
            white-space: nowrap;
            cursor: pointer;
            transition: background .2s;
        }
        .back-btn:hover { background: rgba(255,255,255,.25); }

        /* â”€â”€ MAIN CONTENT â”€â”€ */
        .main {
            max-width: 700px;
            margin: 2rem auto;
            padding: 0 1rem 3rem;
        }

        /* â”€â”€ SECTION TITLE â”€â”€ */
        .section-title {
            text-align: center;
            margin-bottom: 1.75rem;
        }
        .section-title h2 {
            font-size: 1.25rem;
            font-weight: 900;
            color: var(--green);
        }
        .section-title p {
            font-size: .82rem;
            color: #9ca3af;
            margin-top: .3rem;
        }

        /* â”€â”€ STATS GRID â”€â”€ */
        .stats-grid {
            display: grid;
            grid-template-columns: repeat(3, 1fr);
            gap: 1rem;
        }
        @media (max-width: 500px) {
            .stats-grid { grid-template-columns: repeat(2, 1fr); }
            .stat-total { grid-column: span 2; }
        }

        .stat-card {
            background: white;
            border-radius: 16px;
            padding: 1.4rem 1rem;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            text-align: center;
            box-shadow: 0 4px 16px rgba(0,0,0,.07);
            border: 1px solid rgba(0,0,0,.05);
            transition: transform .2s, box-shadow .2s;
            position: relative;
            overflow: hidden;
        }
        .stat-card::before {
            content: '';
            position: absolute;
            top: 0; left: 0; right: 0;
            height: 4px;
        }
        .stat-card.hommes::before { background: linear-gradient(90deg, #16a34a, #4ade80); }
        .stat-card.femmes::before { background: linear-gradient(90deg, #be185d, #f472b6); }
        .stat-card.total::before  { background: linear-gradient(90deg, #2563eb, #60a5fa); }

        .stat-card:hover {
            transform: translateY(-3px);
            box-shadow: 0 8px 24px rgba(0,0,0,.12);
        }

        .stat-icon { font-size: 2rem; margin-bottom: .6rem; }
        .stat-num {
            font-size: 2.4rem;
            font-weight: 900;
            line-height: 1;
            margin-bottom: .3rem;
        }
        .stat-card.hommes .stat-num { color: #16a34a; }
        .stat-card.femmes .stat-num { color: #be185d; }
        .stat-card.total  .stat-num { color: #2563eb; }

        .stat-label {
            font-size: .78rem;
            color: #6b7280;
            font-weight: 700;
        }

        /* â”€â”€ LOADING â”€â”€ */
        .loading {
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            padding: 3rem;
            gap: 1rem;
            color: #9ca3af;
            font-size: .9rem;
        }
        .spinner {
            width: 2.5rem; height: 2.5rem;
            border: 3px solid #e5e7eb;
            border-top-color: var(--green-light);
            border-radius: 50%;
            animation: spin .8s linear infinite;
        }
        @keyframes spin { to { transform: rotate(360deg); } }

        /* â”€â”€ ERROR â”€â”€ */
        .error-msg {
            text-align: center;
            padding: 2rem;
            color: #dc2626;
            font-size: .9rem;
        }

        /* â”€â”€ REFRESH BTN â”€â”€ */
        .refresh-wrap {
            text-align: center;
            margin-top: 2rem;
        }
        .refresh-btn {
            background: var(--green);
            color: white;
            border: none;
            padding: .6rem 1.5rem;
            border-radius: 10px;
            font-family: 'Cairo', sans-serif;
            font-size: .85rem;
            font-weight: 700;
            cursor: pointer;
            transition: background .2s;
        }
        .refresh-btn:hover { background: var(--green-light); }

        /* â”€â”€ LAST UPDATE â”€â”€ */
        .last-update {
            text-align: center;
            margin-top: 1.25rem;
            font-size: .75rem;
            color: #b0b8c1;
        }
    </style>
</head>
<body>

<!-- HEADER -->
<div class="header">
    <div class="header-side">
        <a href="/" class="back-btn" id="backBtn">â† Ø§Ù„Ø±Ø¦ÙŠØ³ÙŠØ©</a>
    </div>
    <div class="header-center">
        <div class="header-title" id="pageTitle">Ø¥Ø­ØµØ§Ø¡Ø§Øª Ø§Ù„Ø£Ø¹Ø¶Ø§Ø¡</div>
        <div class="header-sub">Ø±Ø§Ø¨Ø·Ø© Ø§Ù„Ø·Ù„ÙŠØ¹Ø© Ø§Ù„Ø´Ø¨Ø§Ø¨ÙŠØ© Ù„Ø¨Ù„Ø¯ÙŠØ© Ù…Ù„Ø²Ù… ØªÙŠØ´Ø·</div>
    </div>
    <div class="header-side" style="justify-content: flex-end;">
        <div id="langBtnWrap"></div>
    </div>
</div>

<!-- MAIN -->
<div class="main">
    <div class="section-title">
        <h2 id="sectionTitle">ğŸ“Š Ø§Ù„Ø¥Ø­ØµØ§Ø¡Ø§Øª Ø§Ù„Ø¹Ø§Ù…Ø©</h2>
        <p id="sectionSub">Ø¥Ø¬Ù…Ø§Ù„ÙŠ Ø§Ù„Ø£Ø¹Ø¶Ø§Ø¡ Ø§Ù„Ù…Ø³Ø¬Ù„ÙŠÙ† ÙÙŠ Ø§Ù„Ø±Ø§Ø¨Ø·Ø©</p>
    </div>

    <!-- LOADING STATE -->
    <div id="loadingState" class="loading">
        <div class="spinner"></div>
        <span id="loadingText">Ø¬Ø§Ø±ÙŠ Ø§Ù„ØªØ­Ù…ÙŠÙ„...</span>
    </div>

    <!-- STATS -->
    <div id="statsWrap" style="display:none;">
        <div class="stats-grid">

            <div class="stat-card hommes">
                <div class="stat-icon">ğŸ‘¨</div>
                <div class="stat-num" id="sH">0</div>
                <div class="stat-label" id="lblH">Ù…Ø¬Ù…ÙˆØ¹ Ø§Ù„Ø±Ø¬Ø§Ù„</div>
            </div>

            <div class="stat-card femmes">
                <div class="stat-icon">ğŸ‘©</div>
                <div class="stat-num" id="sF">0</div>
                <div class="stat-label" id="lblF">Ù…Ø¬Ù…ÙˆØ¹ Ø§Ù„Ù†Ø³Ø§Ø¡</div>
            </div>

            <div class="stat-card total stat-total">
                <div class="stat-icon">ğŸ‘¥</div>
                <div class="stat-num" id="sT">0</div>
                <div class="stat-label" id="lblT">Ø¥Ø¬Ù…Ø§Ù„ÙŠ Ø§Ù„Ø£Ø¹Ø¶Ø§Ø¡</div>
            </div>

        </div>

        <div class="refresh-wrap">
            <button class="refresh-btn" onclick="loadStats()" id="refreshBtn">ğŸ”„ ØªØ­Ø¯ÙŠØ«</button>
        </div>

        <div class="last-update" id="lastUpdate"></div>
    </div>

    <!-- ERROR STATE -->
    <div id="errorState" style="display:none;" class="error-msg">
        <p id="errorText">âŒ Ø®Ø·Ø£ ÙÙŠ ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª</p>
    </div>
</div>

<!-- lang.js doit Ãªtre chargÃ© avant ce script -->
<script src="/lang.js"></script>
<script>

    // â”€â”€ Injecter le bouton de langue â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
    document.getElementById('langBtnWrap').innerHTML = getLangBtnHTML('dark');
    updateLangBtn();

    // â”€â”€ Appliquer les traductions â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
    function applyLang() {
        document.documentElement.lang = currentLang;
        document.documentElement.dir = currentLang === 'ar' ? 'rtl' : 'ltr';

        document.getElementById('backBtn').textContent    = t('list.back');
        document.getElementById('pageTitle').textContent  = t('stats.page.title');
        document.getElementById('sectionTitle').textContent = t('stats.section.title');
        document.getElementById('sectionSub').textContent   = t('stats.section.sub');
        document.getElementById('lblH').textContent       = t('stat.totalh');
        document.getElementById('lblF').textContent       = t('stat.totalf');
        document.getElementById('lblT').textContent       = t('stat.totalmembers');
        document.getElementById('loadingText').textContent = t('stats.loading');
        document.getElementById('refreshBtn').textContent  = t('stats.refresh');
        document.getElementById('errorText').textContent   = t('stats.error');

        updateLangBtn();
        updateLastUpdate();
    }

    // â”€â”€ Timestamp derniÃ¨re mise Ã  jour â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
    let lastFetchTime = null;

    function updateLastUpdate() {
        const el = document.getElementById('lastUpdate');
        if (!lastFetchTime) { el.textContent = ''; return; }
        const label = currentLang === 'ar' ? 'Ø¢Ø®Ø± ØªØ­Ø¯ÙŠØ«:' : 'DerniÃ¨re mise Ã  jour :';
        const time  = lastFetchTime.toLocaleTimeString(
            currentLang === 'ar' ? 'ar-MA' : 'fr-FR',
            { hour: '2-digit', minute: '2-digit', second: '2-digit' }
        );
        el.textContent = `${label} ${time}`;
    }

    // â”€â”€ Chargement des donnÃ©es â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
    async function loadStats() {
        document.getElementById('loadingState').style.display  = 'flex';
        document.getElementById('statsWrap').style.display     = 'none';
        document.getElementById('errorState').style.display    = 'none';

        try {
            const [r1, r2] = await Promise.all([
                fetch('/api/membreMelzem'),
                fetch('/api/femmesMelzem')
            ]);
            const d1 = await r1.json();
            const d2 = await r2.json();

            const hommes = (d1.membreMelzem  || []).length;
            const femmes = (d2.femmesMelzem  || []).length;
            const total  = hommes + femmes;

            // Animer les chiffres
            animateCount('sH', hommes);
            animateCount('sF', femmes);
            animateCount('sT', total);

            lastFetchTime = new Date();
            updateLastUpdate();

            document.getElementById('loadingState').style.display = 'none';
            document.getElementById('statsWrap').style.display    = 'block';

        } catch (err) {
            console.error(err);
            document.getElementById('loadingState').style.display = 'none';
            document.getElementById('errorState').style.display   = 'block';
        }
    }

    // â”€â”€ Animation compteur â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
    function animateCount(id, target) {
        const el = document.getElementById(id);
        const duration = 900;
        const start    = performance.now();
        const from     = parseInt(el.textContent) || 0;

        function step(now) {
            const progress = Math.min((now - start) / duration, 1);
            const ease     = 1 - Math.pow(1 - progress, 3); // ease-out cubic
            el.textContent = Math.round(from + (target - from) * ease);
            if (progress < 1) requestAnimationFrame(step);
        }
        requestAnimationFrame(step);
    }

    // â”€â”€ Init â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
    applyLang();
    loadStats();
</script>
</body>
</html>