<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ÿ™ÿ≥ÿ¨ŸäŸÑ ÿßŸÑŸÜÿ≥ÿßÿ° - ÿ±ÿßÿ®ÿ∑ÿ© ÿßŸÑÿ∑ŸÑŸäÿπÿ© ÿßŸÑÿ¥ÿ®ÿßÿ®Ÿäÿ© ŸÑÿ®ŸÑÿØŸäÿ© ŸÖŸÑÿ≤ŸÖ ÿ™Ÿäÿ¥ÿ∑</title>
    <link href="https://fonts.googleapis.com/css2?family=Cairo:wght@400;600;700;900&display=swap" rel="stylesheet">
    <style>
        :root { --pink:#9b2c5a; --pink-light:#d4618a; --pink-soft:#fce8f0; --gold:#c9a84c; }
        * { box-sizing:border-box; margin:0; padding:0; }
        body { font-family:'Cairo',sans-serif; background:linear-gradient(135deg,#1f0d14,#3a1a26 50%,#1f0d14); min-height:100vh; display:flex; flex-direction:column; align-items:center; justify-content:center; padding:1.5rem; }
        body::before { content:''; position:fixed; inset:0; background:radial-gradient(ellipse at 70% 40%,rgba(155,44,90,.12) 0%,transparent 60%); pointer-events:none; }
        .topbar-fixed { position:fixed; top:1rem; left:1rem; right:1rem; display:flex; justify-content:space-between; align-items:center; z-index:100; }
        .back-btn { background:rgba(255,255,255,.1); border:1px solid rgba(255,255,255,.2); color:white; padding:.5rem 1rem; border-radius:8px; text-decoration:none; font-size:.85rem; font-family:'Cairo',sans-serif; }
        .back-btn:hover { background:rgba(255,255,255,.18); }
        .card { background:rgba(255,255,255,.97); border-radius:20px; width:100%; max-width:460px; overflow:hidden; box-shadow:0 25px 60px rgba(0,0,0,.5); position:relative; z-index:1; margin-top:3.5rem; }
        .card-header { background:linear-gradient(135deg,var(--pink),var(--pink-light)); padding:2rem 1.5rem; text-align:center; position:relative; }
        .card-header::after { content:''; position:absolute; bottom:0;left:0;right:0; height:3px; background:linear-gradient(90deg,transparent,var(--gold),transparent); }
        .header-icon { width:70px;height:70px; background:rgba(255,255,255,.15); border-radius:50%; display:flex;align-items:center;justify-content:center; font-size:2rem; margin:0 auto 1rem; border:2px solid rgba(255,255,255,.3); }
        .card-header h1 { color:white; font-size:1.5rem; font-weight:700; }
        .card-header p { color:rgba(255,255,255,.75); font-size:.85rem; margin-top:.25rem; }
        .card-body { padding:2rem 1.75rem; }
        .form-group { margin-bottom:1.25rem; }
        label { display:block; font-size:.85rem; font-weight:700; color:#4a1a2e; margin-bottom:.4rem; }
        .input-wrap { position:relative; }
        .input-icon { position:absolute; right:12px; top:50%; transform:translateY(-50%); font-size:1.1rem; pointer-events:none; }
        input, select { width:100%; padding:.75rem 2.5rem .75rem 1rem; border:2px solid #e2e8f0; border-radius:10px; font-family:'Cairo',sans-serif; font-size:.9rem; color:#1a202c; background:#f8fafc; transition:border-color .2s,box-shadow .2s; direction:rtl; appearance:none; }
        input:focus, select:focus { outline:none; border-color:var(--pink-light); box-shadow:0 0 0 3px rgba(212,97,138,.12); background:white; }
        .village-grid { display:grid; grid-template-columns:1fr 1fr; gap:.5rem; margin-top:.4rem; }
        .village-chip { display:none; }
        .village-chip + label { display:flex;align-items:center;justify-content:center; padding:.6rem .5rem; border:2px solid #e2e8f0; border-radius:8px; cursor:pointer; font-size:.85rem; font-weight:600; color:#4a5568; background:#f8fafc; transition:all .2s; text-align:center; margin-bottom:0; }
        .village-chip:checked + label { border-color:var(--pink-light); background:var(--pink-soft); color:var(--pink); }
        .btn-submit { width:100%; padding:.9rem; background:linear-gradient(135deg,var(--pink),var(--pink-light)); color:white; border:none; border-radius:12px; font-family:'Cairo',sans-serif; font-size:1rem; font-weight:700; cursor:pointer; margin-top:.5rem; transition:opacity .2s,transform .2s; box-shadow:0 4px 20px rgba(155,44,90,.4); }
        .btn-submit:hover { opacity:.92; transform:translateY(-1px); }
        .field-hint { font-size:.78rem; margin-top:.25rem; }
        .toast { position:fixed; bottom:1.5rem; left:50%; transform:translateX(-50%) translateY(100px); background:#3a1a26; color:white; padding:.75rem 1.5rem; border-radius:12px; font-size:.9rem; font-weight:600; border:1px solid var(--pink-light); transition:transform .4s cubic-bezier(.34,1.56,.64,1); z-index:9999; text-align:center; }
        .toast.show { transform:translateX(-50%) translateY(0); }
        .toast.error { background:#3a1a1a; border-color:#dc2626; }
    </style>
</head>
<body>
<div class="topbar-fixed">
    <a href="/" class="back-btn" id="backBtn"></a>
    <div id="langBtnWrap"></div>
</div>

<div class="card">
    <div class="card-header">
        <div class="header-icon">üë©</div>
        <h1 id="pageTitle"></h1>
        <p>ÿ±ÿßÿ®ÿ∑ÿ© ÿ¥ÿ®ÿßÿ® ÿ®ŸÑÿØŸäÿ© ŸÖŸÑÿ≤ŸÖ ÿ™Ÿäÿ¥ÿ∑</p>
    </div>
    <div class="card-body">
        <form id="form">
            <div class="form-group">
                <label id="lNom"></label>
                <div class="input-wrap">
                    <span class="input-icon">‚úçÔ∏è</span>
                    <input type="text" name="nom" id="iNom" required>
                </div>
            </div>
            <div class="form-group">
                <label id="lTel"></label>
                <div class="input-wrap">
                    <span class="input-icon">üìû</span>
                    <input type="tel" name="telephone" id="iTel" placeholder="22000000">
                </div>
            </div>
            <div class="form-group">
                <label id="lAge"></label>
                <div class="input-wrap">
                    <span class="input-icon">üéÇ</span>
                    <select name="age" required>
                        <option value="" disabled selected id="oAgePh"></option>
                        <option value="18-25">18 - 25</option>
                        <option value="26-35">26 - 35</option>
                        <option value="36-45">36 - 45</option>
                        <option value="46-55">46 - 55</option>
                        <option value="56+">56+</option>
                    </select>
                </div>
            </div>
            <div class="form-group">
                <label id="lVillage"></label>
                <div class="village-grid">

                    <input type="radio" class="village-chip" name="village" id="v1" value="ÿ¨ÿØÿ©" required>
                    <label for="v1" data-lang="village.jadda"></label>

                    <input type="radio" class="village-chip" name="village" id="v2" value="ÿßŸÑÿ≠ŸÑÿ©">
                    <label for="v2" data-lang="village.halla"></label>

                    <input type="radio" class="village-chip" name="village" id="v3" value="ŸàÿØŸäÿ¥ÿ±ŸÉ">
                    <label for="v3" data-lang="village.wadichark"></label>

                    <input type="radio" class="village-chip" name="village" id="v4" value="ÿØŸàÿßÿ¥">
                    <label for="v4" data-lang="village.dawach"></label>

                    <input type="radio" class="village-chip" name="village" id="v5" value="ŸÑŸÖÿ≠Ÿäÿµÿ±">
                    <label for="v5" data-lang="village.lmhaysar"></label>

                    <input type="radio" class="village-chip" name="village" id="v6" value="ÿ™ŸàŸäÿ≤ŸÉÿ±Ÿá">
                    <label for="v6" data-lang="village.twizikra"></label>

                    <input type="radio" class="village-chip" name="village" id="v7" value="ÿØÿßÿ± ÿßŸÑÿ≥ŸÑÿßŸÖ">
                    <label for="v7" data-lang="village.darssalam"></label>

                    <input type="radio" class="village-chip" name="village" id="v8" value="ŸÑŸÅÿ±Ÿäÿπ">
                    <label for="v8" data-lang="village.lfray3"></label>

                </div>
            </div>
            <button type="submit" class="btn-submit" id="btnSubmit"></button>
        </form>
    </div>
</div>
<div class="toast" id="toast"></div>

<script src="/lang.js"></script>
<script>
function applyLang() {
    document.documentElement.lang = currentLang;
    document.documentElement.dir = currentLang === 'ar' ? 'rtl' : 'ltr';
    document.querySelectorAll('input[type="text"], input[type="tel"]').forEach(el => {
        el.style.direction = currentLang === 'fr' ? 'ltr' : 'rtl';
    });
    document.getElementById('backBtn').textContent = t('form.back');
    document.getElementById('pageTitle').textContent = t('form.header.f');
    document.getElementById('lNom').textContent = t('form.nom') + ' *';
    document.getElementById('iNom').placeholder = t('form.nomF.placeholder');
    document.getElementById('lTel').textContent = t('form.tel') + ' *';
    document.getElementById('lAge').textContent = t('form.age') + ' *';
    document.getElementById('oAgePh').textContent = t('form.age.placeholder.f');
    document.getElementById('lVillage').textContent = t('form.village') + ' *';
    document.getElementById('btnSubmit').textContent = t('form.submit.f');
    updateLangBtn();
    translateDataLang(); // ‚Üê traduit tous les data-lang en une fois
    updateLangBtn();
}

document.getElementById('langBtnWrap').innerHTML = getLangBtnHTML('dark');
applyLang();

let telTimer = null, nomTimer = null;

document.getElementById('iTel').addEventListener('input', function() {
    clearTimeout(telTimer);
    setFieldState(this, 'idle');
    if (this.value.trim().length < 6) return;
    telTimer = setTimeout(async () => {
        try {
            const res = await fetch(`/api/check-doublon?telephone=${encodeURIComponent(this.value.trim())}&type=femmesMelzem`);
            const r = await res.json();
            setFieldState(this, r.exists ? 'error' : 'ok', r.exists ? t('dup.tel') : t('dup.tel.ok'));
        } catch {}
    }, 500);
});

document.querySelector('input[name="nom"]').addEventListener('input', function() {
    clearTimeout(nomTimer);
    setFieldState(this, 'idle');
    if (this.value.trim().length < 3) return;
    nomTimer = setTimeout(async () => {
        try {
            const res = await fetch(`/api/check-doublon?nom=${encodeURIComponent(this.value.trim())}&type=femmesMelzem`);
            const r = await res.json();
            if (r.exists) setFieldState(this, 'warn', t('dup.nom.warn'));
        } catch {}
    }, 600);
});

function setFieldState(input, state, msg) {
    const wrap = input.closest('.form-group');
    let hint = wrap.querySelector('.field-hint');
    if (!hint) { hint = document.createElement('div'); hint.className = 'field-hint'; wrap.appendChild(hint); }
    input.style.borderColor = state === 'error' ? '#dc2626' : state === 'ok' ? '#16a34a' : state === 'warn' ? '#d97706' : '#e2e8f0';
    hint.textContent = msg || '';
    hint.style.color = state === 'error' ? '#dc2626' : state === 'ok' ? '#16a34a' : '#d97706';
}

function showToast(msg, type='success') {
    const toast = document.getElementById('toast');
    toast.textContent = msg; toast.className = 'toast ' + type;
    void toast.offsetWidth; toast.classList.add('show');
    setTimeout(() => toast.classList.remove('show'), 3500);
}

document.getElementById('form').addEventListener('submit', async function(e) {
    e.preventDefault();
    const fd = new FormData(this);
    if (!fd.get('village')) { showToast(t('toast.no.village'), 'error'); return; }
    const telInput = document.getElementById('iTel');
    if (telInput.style.borderColor === 'rgb(220, 38, 38)') { showToast(t('dup.tel.blocked'), 'error'); return; }
    const data = { nom: fd.get('nom'), telephone: fd.get('telephone'), age: fd.get('age'), village: fd.get('village') };
    try {
        const res = await fetch('/api/femmesMelzem', { method:'POST', headers:{'Content-Type':'application/json'}, body:JSON.stringify(data) });
        const r = await res.json();
        if (r.success) { showToast(t('toast.success')); this.reset(); document.querySelectorAll('.field-hint').forEach(h => h.textContent = ''); document.querySelectorAll('input').forEach(i => i.style.borderColor = ''); }
        else showToast('‚ö†Ô∏è ' + r.message, 'error');
    } catch { showToast(t('toast.error.conn'), 'error'); }
});
</script>
</body>
</html>