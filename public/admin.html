<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Ù„ÙˆØ­Ø© Ø§Ù„Ø¥Ø¯Ø§Ø±Ø© - Ø±Ø§Ø¨Ø·Ø© Ø§Ù„Ø·Ù„ÙŠØ¹Ø© Ø§Ù„Ø´Ø¨Ø§Ø¨ÙŠØ© Ù„Ø¨Ù„Ø¯ÙŠØ© Ù…Ù„Ø²Ù… ØªÙŠØ´Ø·</title>
    <link href="https://fonts.googleapis.com/css2?family=Cairo:wght@400;600;700;900&display=swap" rel="stylesheet">
    <style>
        :root { --green:#1a5c38; --green-light:#2e8b57; --green-soft:#e8f5ee; --gold:#c9a84c; }
        * { box-sizing:border-box; margin:0; padding:0; }
        body { font-family:'Cairo',sans-serif; background:#f0f4f8; min-height:100vh; }

        /* LOGIN */
        #loginScreen { position:fixed; inset:0; z-index:1000; background:linear-gradient(135deg,#0d1f13,#1a3a22 60%,#0d1f13); display:flex; align-items:center; justify-content:center; padding:1rem; }
        .login-card { background:white; border-radius:20px; padding:2.5rem 2rem; width:100%; max-width:380px; box-shadow:0 30px 70px rgba(0,0,0,.6); }
        .login-logo { text-align:center; margin-bottom:2rem; }
        .login-logo .icon { font-size:3rem; display:block; margin-bottom:.5rem; }
        .login-logo h2 { color:var(--green); font-size:1.3rem; font-weight:900; }
        .login-logo p { color:#9ca3af; font-size:.8rem; }
        .login-field { margin-bottom:1rem; }
        .login-field label { display:block; font-size:.82rem; font-weight:700; color:#374151; margin-bottom:.35rem; }
        .login-field input { width:100%; padding:.7rem 1rem; border:2px solid #e5e7eb; border-radius:10px; font-family:'Cairo',sans-serif; font-size:.9rem; }
        .login-field input:focus { outline:none; border-color:var(--green-light); }
        .login-err { background:#fef2f2; color:#dc2626; border:1px solid #fecaca; border-radius:8px; padding:.6rem 1rem; font-size:.82rem; margin-bottom:1rem; display:none; }
        .login-btn { width:100%; padding:.85rem; background:linear-gradient(135deg,var(--green),var(--green-light)); color:white; border:none; border-radius:12px; font-family:'Cairo',sans-serif; font-size:1rem; font-weight:700; cursor:pointer; box-shadow:0 4px 20px rgba(46,139,87,.4); }
        .login-lang { display:flex; justify-content:center; margin-top:1rem; }
        .lang-btn { background:transparent; border:1.5px solid #e5e7eb; color:#374151; padding:.4rem .9rem; border-radius:8px; font-family:'Cairo',sans-serif; font-size:.8rem; font-weight:700; cursor:pointer; transition:all .2s; display:flex; align-items:center; gap:.5rem; }
        .lang-btn:hover { background:#f3f4f6; }
        .lang-btn.dark { background:rgba(255,255,255,.15); border-color:rgba(255,255,255,.25); color:white; }
        .lang-btn.dark:hover { background:rgba(255,255,255,.25); }

        /* APP */
        #appScreen { display:none; }
        .topbar { background:linear-gradient(135deg,#0d1f13,var(--green)); height:60px; display:flex; align-items:center; justify-content:space-between; padding:0 1.25rem; position:sticky; top:0; z-index:100; box-shadow:0 2px 12px rgba(0,0,0,.3); }
        .topbar-left { display:flex; gap:.5rem; align-items:center; }
        .topbar-title { color:white; font-weight:900; font-size:1rem; }
        .topbar-sub { color:rgba(255,255,255,.6); font-size:.7rem; }
        .topbar-btn { background:rgba(255,255,255,.15); border:1px solid rgba(255,255,255,.25); color:white; padding:.4rem .9rem; border-radius:8px; cursor:pointer; font-family:'Cairo',sans-serif; font-size:.8rem; text-decoration:none; transition:background .2s; }
        .topbar-btn:hover { background:rgba(255,255,255,.25); }
        .topbar-btn.danger { background:rgba(220,38,38,.3); border-color:rgba(220,38,38,.5); }

        .tab-nav { background:white; border-bottom:2px solid #e5e7eb; display:flex; overflow-x:auto; padding:0 1rem; }
        .tab-nav::-webkit-scrollbar { display:none; }
        .tnav-btn { padding:.85rem 1.25rem; border:none; background:none; font-family:'Cairo',sans-serif; font-size:.88rem; font-weight:600; color:#9ca3af; cursor:pointer; white-space:nowrap; border-bottom:3px solid transparent; margin-bottom:-2px; transition:all .2s; }
        .tnav-btn.active { color:var(--green); border-bottom-color:var(--green); }

        .content { padding:1.25rem; max-width:1100px; margin:0 auto; }

        /* STATS */
        .stats-grid { display:grid; grid-template-columns:repeat(auto-fill,minmax(160px,1fr)); gap:.75rem; margin-bottom:1.5rem; }
        .stat-card { background:white; border-radius:14px; padding:1.1rem 1rem; box-shadow:0 2px 8px rgba(0,0,0,.06); display:flex; align-items:center; justify-content:space-between; }
        .stat-num { font-size:1.75rem; font-weight:900; line-height:1; }
        .stat-lbl { font-size:.7rem; color:#6b7280; font-weight:600; margin-top:.2rem; }
        .stat-icon { font-size:1.8rem; }

        /* CHARTS */
        .charts-row { display:grid; grid-template-columns:1fr 1fr; gap:.75rem; margin-bottom:1.5rem; }
        @media(max-width:640px) { .charts-row{grid-template-columns:1fr} }
        .chart-card { background:white; border-radius:14px; padding:1.25rem; box-shadow:0 2px 8px rgba(0,0,0,.06); }
        .chart-title { font-size:.88rem; font-weight:700; color:#374151; margin-bottom:1rem; }
        .bar-chart { display:flex; flex-direction:column; gap:.5rem; }
        .bar-row { display:flex; align-items:center; gap:.5rem; font-size:.78rem; }
        .bar-label { width:75px; text-align:right; color:#6b7280; font-weight:600; font-size:.72rem; white-space:nowrap; overflow:hidden; text-overflow:ellipsis; }
        .bar-track { flex:1; height:20px; background:#f3f4f6; border-radius:10px; overflow:hidden; }
        .bar-fill { height:100%; border-radius:10px; transition:width .6s ease; min-width:2px; }
        .bar-count { width:28px; text-align:left; color:#374151; font-weight:700; font-size:.78rem; }
        .donut-wrap { display:flex; align-items:center; gap:1.5rem; flex-wrap:wrap; }
        .donut-legend { display:flex; flex-direction:column; gap:.5rem; }
        .legend-item { display:flex; align-items:center; gap:.5rem; font-size:.8rem; color:#374151; }
        .legend-dot { width:12px; height:12px; border-radius:3px; flex-shrink:0; }

        /* TABLES */
        .section-header { display:flex; justify-content:space-between; align-items:center; margin-bottom:.75rem; flex-wrap:wrap; gap:.5rem; }
        .section-header h3 { font-size:1rem; font-weight:700; color:#1f2937; }
        .toolbar { display:flex; gap:.5rem; flex-wrap:wrap; align-items:center; }
        .search-box { position:relative; }
        .search-box input { padding:.45rem 1.8rem .45rem .8rem; border:1.5px solid #e2e8f0; border-radius:8px; font-family:'Cairo',sans-serif; font-size:.82rem; direction:rtl; width:180px; }
        .search-box input:focus { outline:none; border-color:var(--green-light); }
        .search-icon { position:absolute; right:.5rem; top:50%; transform:translateY(-50%); color:#9ca3af; font-size:.85rem; }
        .filter-btn { padding:.4rem .8rem; border-radius:20px; border:1.5px solid #e2e8f0; background:white; font-family:'Cairo',sans-serif; font-size:.75rem; font-weight:600; color:#6b7280; cursor:pointer; transition:all .2s; }
        .filter-btn.active { background:var(--green-soft); border-color:var(--green-light); color:var(--green); }
        .print-btn { padding:.45rem .9rem; background:var(--green); color:white; border:none; border-radius:8px; font-family:'Cairo',sans-serif; font-size:.8rem; font-weight:700; cursor:pointer; transition:background .2s; }
        .print-btn:hover { background:var(--green-light); }
        .panel { background:white; border-radius:14px; box-shadow:0 2px 8px rgba(0,0,0,.06); overflow:hidden; }
        table { width:100%; border-collapse:collapse; font-size:.85rem; }
        th { background:#f8fafc; color:#6b7280; font-weight:700; font-size:.72rem; text-transform:uppercase; letter-spacing:.04em; padding:.7rem 1rem; text-align:right; border-bottom:2px solid #f1f5f9; }
        td { padding:.65rem 1rem; border-bottom:1px solid #f8fafc; color:#374151; text-align:right; }
        tr:hover td { background:#fafafa; }
        .badge { display:inline-block; padding:.18rem .55rem; border-radius:20px; font-size:.7rem; font-weight:700; }
        .badge-green { background:#dcfce7; color:#15803d; }
        .badge-yellow { background:#fef9c3; color:#92400e; }
        .badge-village { background:#eff6ff; color:#1d4ed8; }
        .del-btn { background:none; border:none; color:#dc2626; cursor:pointer; font-size:.85rem; padding:.2rem .4rem; border-radius:4px; transition:background .2s; }
        .del-btn:hover { background:#fef2f2; }
        .mobile-cards { display:none; padding:.75rem; }
        @media(max-width:640px) { table{display:none} .mobile-cards{display:block} }
        .mc { border:1px solid #e5e7eb; border-radius:10px; padding:.875rem; margin-bottom:.65rem; }
        .mc-header { display:flex; justify-content:space-between; align-items:center; margin-bottom:.4rem; }
        .mc-name { font-weight:700; color:#111827; }
        .mc-row { display:flex; justify-content:space-between; padding:.28rem 0; border-top:1px solid #f3f4f6; font-size:.8rem; }
        .mc-lbl { color:#9ca3af; }
        .mc-val { color:#374151; font-weight:600; }

        /* LOADING */
        .loading { padding:2.5rem; text-align:center; color:#9ca3af; }
        .spinner { display:inline-block; width:2rem; height:2rem; border:3px solid #e5e7eb; border-top-color:var(--green-light); border-radius:50%; animation:spin .8s linear infinite; }
        @keyframes spin { to{transform:rotate(360deg)} }
        .empty { padding:2.5rem; text-align:center; color:#9ca3af; font-size:.9rem; }

        /* CONFIRM MODAL */
        .overlay { position:fixed; inset:0; background:rgba(0,0,0,.5); z-index:500; display:none; align-items:center; justify-content:center; }
        .overlay.show { display:flex; }
        .confirm-box { background:white; border-radius:16px; padding:1.75rem; max-width:340px; width:90%; text-align:center; }
        .confirm-box h4 { font-size:1.1rem; font-weight:700; margin-bottom:.5rem; }
        .confirm-box p { color:#6b7280; font-size:.85rem; margin-bottom:1.25rem; }
        .confirm-btns { display:flex; gap:.75rem; justify-content:center; }
        .btn-cancel { padding:.6rem 1.2rem; border:1.5px solid #e5e7eb; border-radius:8px; background:white; font-family:'Cairo',sans-serif; font-weight:700; cursor:pointer; }
        .btn-delete { padding:.6rem 1.2rem; border:none; border-radius:8px; background:#dc2626; color:white; font-family:'Cairo',sans-serif; font-weight:700; cursor:pointer; }

        /* PRINT */
        #printTable { display:none; }
        @media print {
            body>*:not(#printTable) { display:none !important; }
            #printTable { display:block !important; padding:20px; font-family:Cairo,sans-serif; }
            @page { margin:1cm; size:A4 portrait; }
        }

        /* LOADING OVERLAY pour donnÃ©es */
        .data-loading { display:flex; flex-direction:column; align-items:center; justify-content:center; padding:3rem; gap:.75rem; color:#9ca3af; }
        .data-error { padding:2rem; text-align:center; color:#dc2626; font-size:.9rem; }
        .retry-btn { margin-top:.75rem; padding:.5rem 1.2rem; background:var(--green); color:white; border:none; border-radius:8px; font-family:'Cairo',sans-serif; font-weight:700; cursor:pointer; }
    </style>
</head>
<body>

<!-- â•â• LOGIN â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• -->
<div id="loginScreen">
    <div class="login-card">
        <div class="login-logo">
            <span class="icon">ğŸ”</span>
            <h2 id="loginTitle"></h2>
            <p>Ø±Ø§Ø¨Ø·Ø© Ø§Ù„Ø·Ù„ÙŠØ¹Ø© Ø§Ù„Ø´Ø¨Ø§Ø¨ÙŠØ© Ù„Ø¨Ù„Ø¯ÙŠØ© Ù…Ù„Ø²Ù… ØªÙŠØ´Ø·</p>
        </div>
        <div class="login-err" id="loginErr"></div>
        <div class="login-field">
            <label id="loginPwdLbl"></label>
            <input type="password" id="pwdInput" onkeydown="if(event.key==='Enter')doLogin()">
        </div>
        <button class="login-btn" id="loginBtnEl" onclick="doLogin()"></button>
        <div class="login-lang" id="loginLangWrap"></div>
    </div>
</div>

<!-- â•â• APP â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• -->
<div id="appScreen">

    <!-- Topbar -->
    <div class="topbar">
        <div>
            <div class="topbar-title" id="tbTitle"></div>
            <div class="topbar-sub">Ø±Ø§Ø¨Ø·Ø© Ø§Ù„Ø·Ù„ÙŠØ¹Ø© Ø§Ù„Ø´Ø¨Ø§Ø¨ÙŠØ© Ù„Ø¨Ù„Ø¯ÙŠØ© Ù…Ù„Ø²Ù… ØªÙŠØ´Ø·</div>
        </div>
        <div class="topbar-left">
            <div id="appLangWrap"></div>
            <a href="/" class="topbar-btn" id="tbHome"></a>
            <button class="topbar-btn danger" id="tbLogout" onclick="logout()"></button>
        </div>
    </div>

    <!-- Tabs -->
    <div class="tab-nav">
        <button class="tnav-btn active" id="tn0" onclick="showSection('stats')"></button>
        <button class="tnav-btn"        id="tn1" onclick="showSection('hommes')"></button>
        <button class="tnav-btn"        id="tn2" onclick="showSection('femmes')"></button>
    </div>

    <div class="content">

        <!-- â”€â”€ STATS â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ -->
        <div id="secStats">
            <div class="stats-grid">
                <div class="stat-card"><div><div class="stat-num" id="sH"   style="color:#16a34a">â€”</div><div class="stat-lbl" id="sH_lbl"></div></div><div class="stat-icon">ğŸ‘¨</div></div>
                <div class="stat-card"><div><div class="stat-num" id="sF"   style="color:#be185d">â€”</div><div class="stat-lbl" id="sF_lbl"></div></div><div class="stat-icon">ğŸ‘©</div></div>
                <div class="stat-card"><div><div class="stat-num" id="sT"   style="color:#2563eb">â€”</div><div class="stat-lbl" id="sT_lbl"></div></div><div class="stat-icon">ğŸ‘¥</div></div>
                <div class="stat-card"><div><div class="stat-num" id="sTr"  style="color:#16a34a">â€”</div><div class="stat-lbl" id="sTr_lbl"></div></div><div class="stat-icon">ğŸ’¼</div></div>
                <div class="stat-card"><div><div class="stat-num" id="sCh"  style="color:#dc2626">â€”</div><div class="stat-lbl" id="sCh_lbl"></div></div><div class="stat-icon">ğŸ </div></div>
                <div class="stat-card"><div><div class="stat-num" id="sAuj" style="color:#7c3aed">â€”</div><div class="stat-lbl" id="sAuj_lbl"></div></div><div class="stat-icon">ğŸ“…</div></div>
            </div>
            <div class="charts-row">
                <div class="chart-card"><div class="chart-title" id="chVH"></div><div class="bar-chart" id="chartVH"><div class="data-loading"><div class="spinner"></div></div></div></div>
                <div class="chart-card"><div class="chart-title" id="chVF"></div><div class="bar-chart" id="chartVF"><div class="data-loading"><div class="spinner"></div></div></div></div>
                <div class="chart-card"><div class="chart-title" id="chAH"></div><div class="bar-chart" id="chartAH"><div class="data-loading"><div class="spinner"></div></div></div></div>
                <div class="chart-card">
                    <div class="chart-title" id="chEm"></div>
                    <div class="donut-wrap">
                        <svg width="100" height="100" viewBox="0 0 36 36">
                            <circle cx="18" cy="18" r="15.9155" fill="transparent" stroke="#e5e7eb" stroke-width="3.5"/>
                            <circle cx="18" cy="18" r="15.9155" fill="transparent" stroke="#16a34a" stroke-width="3.5" stroke-dasharray="0 100" stroke-dashoffset="25" stroke-linecap="round" id="donutG" style="transition:stroke-dasharray .8s"/>
                            <circle cx="18" cy="18" r="15.9155" fill="transparent" stroke="#fbbf24" stroke-width="3.5" stroke-dasharray="0 100" stroke-dashoffset="25" id="donutY" style="transition:stroke-dasharray .8s"/>
                        </svg>
                        <div class="donut-legend">
                            <div class="legend-item"><div class="legend-dot" style="background:#16a34a"></div><span id="dLblO"></span></div>
                            <div class="legend-item"><div class="legend-dot" style="background:#fbbf24"></div><span id="dLblN"></span></div>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- â”€â”€ HOMMES â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ -->
        <div id="secHommes" style="display:none">
            <div class="section-header">
                <h3 id="secHTitle"></h3>
                <div class="toolbar">
                    <div class="search-box">
                        <span class="search-icon">ğŸ”</span>
                        <input type="text" id="searchH" oninput="renderH()">
                    </div>
                    <button class="filter-btn active" onclick="setFH('all',this)"       id="fhAll"></button>
                    <button class="filter-btn"        onclick="setFH('travaille',this)" id="fhTrav"></button>
                    <button class="filter-btn"        onclick="setFH('chomage',this)"   id="fhChom"></button>
                    <button class="print-btn" onclick="doPrint('hommes')" id="pBtnH"></button>
                </div>
            </div>
            <div class="panel">
                <div id="hLoadingState" class="data-loading"><div class="spinner"></div></div>
                <div id="hTableWrap" style="display:none">
                    <div class="table-wrap">
                        <table dir="rtl">
                            <thead><tr id="thH"></tr></thead>
                            <tbody id="hBody"></tbody>
                        </table>
                    </div>
                    <div id="hMobile" class="mobile-cards"></div>
                </div>
            </div>
        </div>

        <!-- â”€â”€ FEMMES â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ -->
        <div id="secFemmes" style="display:none">
            <div class="section-header">
                <h3 id="secFTitle"></h3>
                <div class="toolbar">
                    <div class="search-box">
                        <span class="search-icon">ğŸ”</span>
                        <input type="text" id="searchF" oninput="renderF()">
                    </div>
                    <button class="print-btn" onclick="doPrint('femmesMelzem')" id="pBtnF"></button>
                </div>
            </div>
            <div class="panel">
                <div id="fLoadingState" class="data-loading"><div class="spinner"></div></div>
                <div id="fTableWrap" style="display:none">
                    <div class="table-wrap">
                        <table dir="rtl">
                            <thead><tr id="thF"></tr></thead>
                            <tbody id="fBody"></tbody>
                        </table>
                    </div>
                    <div id="fMobile" class="mobile-cards"></div>
                </div>
            </div>
        </div>

    </div><!-- /content -->
</div><!-- /appScreen -->

<!-- â•â• CONFIRM MODAL â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• -->
<div class="overlay" id="confirmOverlay">
    <div class="confirm-box">
        <h4 id="confirmTitle"></h4>
        <p  id="confirmMsg"></p>
        <div class="confirm-btns">
            <button class="btn-cancel" id="confirmCancel" onclick="closeConfirm()"></button>
            <button class="btn-delete" id="confirmDel"    onclick="confirmDelete()"></button>
        </div>
    </div>
</div>

<div id="printTable"></div>

<!-- â•â• SCRIPTS â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• -->
<script src="/lang.js"></script>
<script>

const ADMIN_PWD = 'admin2026';
let hommesData  = [];
let femmesData  = [];
let filterH     = 'all';
let deleteTarget = null;
let deleteType   = null;
let dataLoaded   = false;   // â† flag pour Ã©viter double chargement

// â”€â”€ TRADUCTIONS â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function applyLang() {
    document.documentElement.lang = currentLang;
    document.documentElement.dir  = currentLang === 'ar' ? 'rtl' : 'ltr';

    // Login
    document.getElementById('loginTitle').textContent   = t('admin.login.title');
    document.getElementById('loginPwdLbl').textContent  = t('admin.login.pwd');
    document.getElementById('loginBtnEl').textContent   = t('admin.login.btn');
    document.getElementById('loginErr').textContent     = t('admin.login.err');

    // Topbar
    document.getElementById('tbTitle').textContent  = 'ğŸ›¡ï¸ ' + t('admin.title');
    document.getElementById('tbHome').textContent   = t('admin.home');
    document.getElementById('tbLogout').textContent = t('admin.logout');

    // Tabs
    document.getElementById('tn0').textContent = t('admin.tab.stats');
    document.getElementById('tn1').textContent = t('admin.tab.hommes');
    document.getElementById('tn2').textContent = t('admin.tab.femmes');

    // Stats labels
    document.getElementById('sH_lbl').textContent   = t('admin.stat.hommes');
    document.getElementById('sF_lbl').textContent   = t('admin.stat.femmes');
    document.getElementById('sT_lbl').textContent   = t('admin.stat.total');
    document.getElementById('sTr_lbl').textContent  = t('admin.stat.travaille');
    document.getElementById('sCh_lbl').textContent  = t('admin.stat.chomage');
    document.getElementById('sAuj_lbl').textContent = t('admin.stat.today');

    // Chart titles
    document.getElementById('chVH').textContent = t('admin.chart.vilH');
    document.getElementById('chVF').textContent = t('admin.chart.vilF');
    document.getElementById('chAH').textContent = t('admin.chart.ageH');
    document.getElementById('chEm').textContent = t('admin.chart.emploi');

    // Sections
    document.getElementById('secHTitle').textContent = t('admin.sec.hommes');
    document.getElementById('secFTitle').textContent = t('admin.sec.femmes');
    document.getElementById('searchH').placeholder   = t('admin.search');
    document.getElementById('searchF').placeholder   = t('admin.search');
    document.getElementById('fhAll').textContent     = t('list.filter.all');
    document.getElementById('fhTrav').textContent    = t('list.filter.travaille');
    document.getElementById('fhChom').textContent    = t('list.filter.chomage');
    document.getElementById('pBtnH').textContent     = t('admin.print');
    document.getElementById('pBtnF').textContent     = t('admin.print');

    // Confirm modal
    document.getElementById('confirmTitle').textContent  = t('admin.confirm.title');
    document.getElementById('confirmCancel').textContent = t('admin.confirm.cancel');
    document.getElementById('confirmDel').textContent    = t('admin.confirm.delete');

    // En-tÃªtes des tableaux
    document.getElementById('thH').innerHTML = ['col.num','col.nom','col.tel','col.village','col.age','col.situation','col.date',''].map(k => `<th>${k ? t(k) : ''}</th>`).join('');
    document.getElementById('thF').innerHTML = ['col.num','col.nom','col.tel','col.village','col.age','col.date',''].map(k => `<th>${k ? t(k) : ''}</th>`).join('');

    // Boutons de langue
    const loginBtn = `<button class="lang-btn" onclick="toggleLang()" id="langBtn">
        <span id="langFlag"></span><span id="langLabel"></span>
    </button>`;
    document.getElementById('loginLangWrap').innerHTML = loginBtn;

    const appBtn = `<button class="lang-btn dark" onclick="toggleLang()" id="langBtnApp">
        <span id="langFlagApp"></span><span id="langLabelApp"></span>
    </button>`;
    document.getElementById('appLangWrap').innerHTML = appBtn;

    // Remplir les drapeaux/labels
    _fillLangBtn('langFlag',    'langLabel');
    _fillLangBtn('langFlagApp', 'langLabelApp');

    // Re-render si donnÃ©es chargÃ©es
    if (dataLoaded) {
        renderH();
        renderF();
        buildStats();
    }
}

function _fillLangBtn(flagId, labelId) {
    const flag  = document.getElementById(flagId);
    const label = document.getElementById(labelId);
    if (!flag || !label) return;
    if (currentLang === 'ar') { flag.textContent = 'ğŸ‡«ğŸ‡·'; label.textContent = 'FR'; }
    else                      { flag.textContent = 'ğŸ‡²ğŸ‡·'; label.textContent = 'Ø¹Ø±'; }
}

// â”€â”€ AUTH â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function doLogin() {
    if (document.getElementById('pwdInput').value === ADMIN_PWD) {
        document.getElementById('loginScreen').style.display = 'none';
        document.getElementById('appScreen').style.display   = 'block';
        // Charger les donnÃ©es seulement si pas encore chargÃ©es
        if (!dataLoaded) loadAll();
    } else {
        document.getElementById('loginErr').style.display = 'block';
        document.getElementById('pwdInput').value = '';
    }
}

function logout() {
    document.getElementById('loginScreen').style.display = 'flex';
    document.getElementById('appScreen').style.display   = 'none';
    document.getElementById('pwdInput').value = '';
}

// â”€â”€ TABS â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function showSection(s) {
    const sections = ['Stats', 'Hommes', 'Femmes'];
    sections.forEach((n, i) => {
        document.getElementById('sec' + n).style.display = s === n.toLowerCase() ? 'block' : 'none';
        document.getElementById('tn' + i).classList.toggle('active', s === n.toLowerCase());
    });
}

// â”€â”€ CHARGEMENT DES DONNÃ‰ES â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
async function loadAll() {
    // Afficher les spinners
    showLoading(true);

    try {
        const [r1, r2] = await Promise.all([
            fetch('/api/membreMelzem'),
            fetch('/api/femmesMelzem')
        ]);

        if (!r1.ok || !r2.ok) throw new Error('RÃ©ponse API invalide');

        const d1 = await r1.json();
        const d2 = await r2.json();

        hommesData = d1.membreMelzem  || [];
        femmesData = d2.femmesMelzem  || [];
        dataLoaded = true;

        showLoading(false);
        buildStats();
        renderH();
        renderF();

    } catch (err) {
        console.error('Erreur chargement donnÃ©es:', err);
        showError();
    }
}

function showLoading(isLoading) {
    document.getElementById('hLoadingState').style.display = isLoading ? 'flex'  : 'none';
    document.getElementById('hTableWrap').style.display    = isLoading ? 'none'  : 'block';
    document.getElementById('fLoadingState').style.display = isLoading ? 'flex'  : 'none';
    document.getElementById('fTableWrap').style.display    = isLoading ? 'none'  : 'block';
}

function showError() {
    const errHTML = `<div class="data-error">
        âŒ ${currentLang === 'ar' ? 'Ø®Ø·Ø£ ÙÙŠ ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª' : 'Erreur de chargement'}
        <br><button class="retry-btn" onclick="loadAll()">
            ${currentLang === 'ar' ? 'ğŸ”„ Ø¥Ø¹Ø§Ø¯Ø© Ø§Ù„Ù…Ø­Ø§ÙˆÙ„Ø©' : 'ğŸ”„ RÃ©essayer'}
        </button>
    </div>`;
    document.getElementById('hLoadingState').innerHTML = errHTML;
    document.getElementById('fLoadingState').innerHTML = errHTML;
}

// â”€â”€ STATS & CHARTS â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function buildStats() {
    const trav  = hommesData.filter(m => m.situation === 'Ù†Ø¹Ù…').length;
    const chom  = hommesData.length - trav;
    const today = new Date().toDateString();
    const auj   = [...hommesData, ...femmesData].filter(m => new Date(m.date_inscription).toDateString() === today).length;

    document.getElementById('sH').textContent   = hommesData.length;
    document.getElementById('sF').textContent   = femmesData.length;
    document.getElementById('sT').textContent   = hommesData.length + femmesData.length;
    document.getElementById('sTr').textContent  = trav;
    document.getElementById('sCh').textContent  = chom;
    document.getElementById('sAuj').textContent = auj;

    buildBar('chartVH', countBy(hommesData, 'village'));
    buildBar('chartVF', countBy(femmesData, 'village'));
    buildBar('chartAH', countBy(hommesData, 'age'));

    const pct = hommesData.length ? Math.round(trav / hommesData.length * 100) : 0;
    document.getElementById('donutG').setAttribute('stroke-dasharray', `${pct} ${100 - pct}`);
    document.getElementById('donutY').setAttribute('stroke-dasharray', `${100 - pct} ${pct}`);
    document.getElementById('donutY').setAttribute('stroke-dashoffset', 25 - pct);
    document.getElementById('dLblO').textContent = `${t('admin.donut.oui')}: ${trav} (${pct}%)`;
    document.getElementById('dLblN').textContent = `${t('admin.donut.non')}: ${chom} (${100 - pct}%)`;
}

function countBy(arr, key) {
    const m = {};
    arr.forEach(x => { const v = x[key] || '?'; m[v] = (m[v] || 0) + 1; });
    return Object.entries(m).sort((a, b) => b[1] - a[1]);
}

const COLS = ['#2e8b57','#16a34a','#059669','#0d9488','#0891b2','#7c3aed','#be185d','#dc2626'];

function buildBar(id, entries) {
    const el = document.getElementById(id);
    if (!entries.length) {
        el.innerHTML = `<p style="color:#9ca3af;font-size:.8rem;text-align:center">${t('admin.chart.nodata')}</p>`;
        return;
    }
    const max = entries[0][1];
    el.innerHTML = entries.map(([lbl, cnt], i) => `<div class="bar-row">
        <div class="bar-label" title="${lbl}">${lbl}</div>
        <div class="bar-track"><div class="bar-fill" style="width:${max ? (cnt / max * 100) : 0}%;background:${COLS[i % COLS.length]}"></div></div>
        <div class="bar-count">${cnt}</div>
    </div>`).join('');
}

// â”€â”€ TABLES â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function fmtDate(d) {
    if (!d) return 'â€”';
    return new Date(d).toLocaleDateString(
        currentLang === 'fr' ? 'fr-FR' : 'ar-MA',
        { year:'numeric', month:'short', day:'numeric' }
    );
}

function getFH() {
    let d = hommesData;
    const q = (document.getElementById('searchH')?.value || '').toLowerCase();
    if (q) d = d.filter(m =>
        m.nom?.toLowerCase().includes(q) ||
        m.village?.toLowerCase().includes(q) ||
        m.telephone?.includes(q)
    );
    if (filterH === 'travaille') d = d.filter(m => m.situation === 'Ù†Ø¹Ù…');
    if (filterH === 'chomage')   d = d.filter(m => m.situation !== 'Ù†Ø¹Ù…');
    return d;
}

function renderH() {
    if (!dataLoaded) return;
    const data   = getFH();
    const tbody  = document.getElementById('hBody');
    const mobile = document.getElementById('hMobile');

    if (!data.length) {
        tbody.innerHTML  = `<tr><td colspan="8" class="empty">${t('admin.empty')}</td></tr>`;
        mobile.innerHTML = `<div class="empty">${t('admin.empty')}</div>`;
        return;
    }

    tbody.innerHTML = data.map((m, i) => `<tr>
        <td style="color:#9ca3af">${i + 1}</td>
        <td><strong>${m.nom}</strong></td>
        <td>${m.telephone || 'â€”'}</td>
        <td><span class="badge badge-village">${m.village || 'â€”'}</span></td>
        <td>${m.age || 'â€”'}</td>
        <td><span class="badge ${m.situation === 'Ù†Ø¹Ù…' ? 'badge-green' : 'badge-yellow'}">
            ${m.situation === 'Ù†Ø¹Ù…' ? t('badge.travaille') : t('badge.chomage')}
        </span></td>
        <td style="color:#9ca3af;font-size:.78rem">${fmtDate(m.date_inscription)}</td>
        <td><button class="del-btn" onclick="askDelete(${m.id},'hommes','${m.nom.replace(/'/g,"\\'")}')">ğŸ—‘ï¸</button></td>
    </tr>`).join('');

    mobile.innerHTML = data.map((m, i) => `<div class="mc">
        <div class="mc-header">
            <span class="mc-name">${i + 1}. ${m.nom}</span>
            <span class="badge ${m.situation === 'Ù†Ø¹Ù…' ? 'badge-green' : 'badge-yellow'}">
                ${m.situation === 'Ù†Ø¹Ù…' ? t('badge.travaille') : t('badge.chomage')}
            </span>
        </div>
        <div class="mc-row"><span class="mc-lbl">${t('col.tel')}</span><span class="mc-val">${m.telephone || 'â€”'}</span></div>
        <div class="mc-row"><span class="mc-lbl">${t('col.village')}</span><span class="mc-val">${m.village || 'â€”'}</span></div>
        <div class="mc-row"><span class="mc-lbl">${t('col.age')}</span><span class="mc-val">${m.age || 'â€”'}</span></div>
        <div class="mc-row"><span class="mc-lbl">${t('col.date')}</span><span class="mc-val">${fmtDate(m.date_inscription)}</span></div>
        <div style="text-align:left;margin-top:.5rem">
            <button class="del-btn" onclick="askDelete(${m.id},'hommes','${m.nom.replace(/'/g,"\\'")}')">
                ğŸ—‘ï¸ ${t('admin.confirm.delete')}
            </button>
        </div>
    </div>`).join('');
}

function renderF() {
    if (!dataLoaded) return;
    const q    = (document.getElementById('searchF')?.value || '').toLowerCase();
    const data = femmesData.filter(m =>
        !q || m.nom?.toLowerCase().includes(q) || m.village?.toLowerCase().includes(q)
    );
    const tbody  = document.getElementById('fBody');
    const mobile = document.getElementById('fMobile');

    if (!data.length) {
        tbody.innerHTML  = `<tr><td colspan="7" class="empty">${t('admin.empty')}</td></tr>`;
        mobile.innerHTML = `<div class="empty">${t('admin.empty')}</div>`;
        return;
    }

    tbody.innerHTML = data.map((m, i) => `<tr>
        <td style="color:#9ca3af">${i + 1}</td>
        <td><strong>${m.nom}</strong></td>
        <td>${m.telephone || 'â€”'}</td>
        <td><span class="badge badge-village">${m.village || 'â€”'}</span></td>
        <td>${m.age || 'â€”'}</td>
        <td style="color:#9ca3af;font-size:.78rem">${fmtDate(m.date_inscription)}</td>
        <td><button class="del-btn" onclick="askDelete(${m.id},'femmesMelzem','${m.nom.replace(/'/g,"\\'")}')">ğŸ—‘ï¸</button></td>
    </tr>`).join('');

    mobile.innerHTML = data.map((m, i) => `<div class="mc">
        <div class="mc-header">
            <span class="mc-name">${i + 1}. ${m.nom}</span>
            <span style="font-size:1.2rem">ğŸ‘©</span>
        </div>
        <div class="mc-row"><span class="mc-lbl">${t('col.tel')}</span><span class="mc-val">${m.telephone || 'â€”'}</span></div>
        <div class="mc-row"><span class="mc-lbl">${t('col.village')}</span><span class="mc-val">${m.village || 'â€”'}</span></div>
        <div class="mc-row"><span class="mc-lbl">${t('col.age')}</span><span class="mc-val">${m.age || 'â€”'}</span></div>
        <div class="mc-row"><span class="mc-lbl">${t('col.date')}</span><span class="mc-val">${fmtDate(m.date_inscription)}</span></div>
        <div style="text-align:left;margin-top:.5rem">
            <button class="del-btn" onclick="askDelete(${m.id},'femmesMelzem','${m.nom.replace(/'/g,"\\'")}')">
                ğŸ—‘ï¸ ${t('admin.confirm.delete')}
            </button>
        </div>
    </div>`).join('');
}

function setFH(f, btn) {
    filterH = f;
    document.querySelectorAll('#secHommes .filter-btn').forEach(b => b.classList.remove('active'));
    btn.classList.add('active');
    renderH();
}

// â”€â”€ SUPPRESSION â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function askDelete(id, type, nom) {
    deleteTarget = id;
    deleteType   = type;
    document.getElementById('confirmMsg').textContent = t('admin.confirm.msg').replace('{name}', nom);
    document.getElementById('confirmOverlay').classList.add('show');
}

function closeConfirm() {
    document.getElementById('confirmOverlay').classList.remove('show');
    deleteTarget = null;
    deleteType   = null;
}

async function confirmDelete() {
    if (!deleteTarget) return;
    try {
        const res = await fetch(`/api/${deleteType}/${deleteTarget}`, { method: 'DELETE' });
        const r   = await res.json();
        if (r.success) { await loadAll(); closeConfirm(); }
        else alert('Erreur suppression');
    } catch { alert('Erreur rÃ©seau / Ø®Ø·Ø£ ÙÙŠ Ø§Ù„Ø´Ø¨ÙƒØ©'); }
}

// â”€â”€ IMPRESSION â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function doPrint(type) {
    const isH    = type === 'hommes';
    const data   = isH ? getFH() : femmesData;
    const dateStr = new Date().toLocaleDateString(
        currentLang === 'fr' ? 'fr-FR' : 'ar-MA',
        { weekday:'long', year:'numeric', month:'long', day:'numeric' }
    );
    let html = `<div style="padding:20px;font-family:Cairo,sans-serif;">
        <div style="text-align:center;margin-bottom:24px;padding-bottom:16px;border-bottom:3px double #1a5c38;">
            <h1 style="font-size:20pt;font-weight:900;color:#1a5c38;margin-bottom:4px;">Ø±Ø§Ø¨Ø·Ø© Ø´Ø¨Ø§Ø¨ Ø¨Ù„Ø¯ÙŠØ© Ù…Ù„Ø²Ù… ØªÙŠØ´Ø·</h1>
            <p style="color:#888;font-size:9pt;">Association de la Jeunesse de Melzam Tichit</p>
            <p style="color:#aaa;font-size:8pt;margin-top:4px;">${t('print.printed')} ${dateStr}</p>
        </div>
        <h2 style="font-size:13pt;font-weight:700;text-align:center;margin-bottom:14px;">
            ${isH ? t('print.title.h') : t('print.title.f')} (${data.length} ${t('print.member')})
        </h2>
        <table style="width:100%;border-collapse:collapse;font-size:9pt;" dir="rtl">
        <thead><tr style="background:#e8f5ee;">
            <th style="border:1px solid #ccc;padding:6px;">#</th>
            <th style="border:1px solid #ccc;padding:6px;">${t('col.nom')}</th>
            <th style="border:1px solid #ccc;padding:6px;">${t('col.tel')}</th>
            <th style="border:1px solid #ccc;padding:6px;">${t('col.village')}</th>
            <th style="border:1px solid #ccc;padding:6px;">${t('col.age')}</th>
            ${isH ? `<th style="border:1px solid #ccc;padding:6px;">${t('col.situation')}</th>` : ''}
            <th style="border:1px solid #ccc;padding:6px;">${t('col.date')}</th>
        </tr></thead><tbody>`;

    data.forEach((m, i) => {
        html += `<tr>
            <td style="border:1px solid #ddd;padding:5px;text-align:center;">${i + 1}</td>
            <td style="border:1px solid #ddd;padding:5px;font-weight:600;">${m.nom}</td>
            <td style="border:1px solid #ddd;padding:5px;">${m.telephone || 'â€”'}</td>
            <td style="border:1px solid #ddd;padding:5px;">${m.village || 'â€”'}</td>
            <td style="border:1px solid #ddd;padding:5px;">${m.age || 'â€”'}</td>
            ${isH ? `<td style="border:1px solid #ddd;padding:5px;">${m.situation === 'Ù†Ø¹Ù…' ? t('print.travaille') : t('print.chomage')}</td>` : ''}
            <td style="border:1px solid #ddd;padding:5px;font-size:8pt;">${fmtDate(m.date_inscription)}</td>
        </tr>`;
    });

    html += `</tbody></table></div>`;
    document.getElementById('printTable').innerHTML = html;
    setTimeout(() => window.print(), 100);
}

// â”€â”€ INIT â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
applyLang();

</script>
</body>
</html>