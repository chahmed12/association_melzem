<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Ù„ÙˆØ­Ø© Ø§Ù„Ø¥Ø¯Ø§Ø±Ø© - Ø±Ø§Ø¨Ø·Ø© Ø´Ø¨Ø§Ø¨ Ù…Ù„Ø²Ù… ØªÙŠØ´Ø·</title>
    <link href="https://fonts.googleapis.com/css2?family=Cairo:wght@400;600;700;900&display=swap" rel="stylesheet">
    <style>
        :root {
            --green: #1a5c38;
            --green-light: #2e8b57;
            --green-soft: #e8f5ee;
            --gold: #c9a84c;
            --dark: #0d1f13;
            --sidebar-w: 240px;
        }
        * { box-sizing: border-box; margin: 0; padding: 0; }
        body { font-family: 'Cairo', sans-serif; background: #f0f4f8; min-height: 100vh; }

        /* â”€â”€â”€ LOGIN SCREEN â”€â”€â”€ */
        #loginScreen {
            position: fixed; inset: 0; z-index: 1000;
            background: linear-gradient(135deg, #0d1f13 0%, #1a3a22 60%, #0d1f13 100%);
            display: flex; align-items: center; justify-content: center; padding: 1rem;
        }
        .login-card {
            background: white; border-radius: 20px; padding: 2.5rem 2rem;
            width: 100%; max-width: 380px;
            box-shadow: 0 30px 70px rgba(0,0,0,.6);
        }
        .login-logo { text-align: center; margin-bottom: 2rem; }
        .login-logo .icon { font-size: 3rem; display: block; margin-bottom: .5rem; }
        .login-logo h2 { color: var(--green); font-size: 1.3rem; font-weight: 900; }
        .login-logo p { color: #9ca3af; font-size: .8rem; }
        .login-field { margin-bottom: 1rem; }
        .login-field label { display: block; font-size: .82rem; font-weight: 700; color: #374151; margin-bottom: .35rem; }
        .login-field input {
            width: 100%; padding: .7rem 1rem; border: 2px solid #e5e7eb;
            border-radius: 10px; font-family: 'Cairo', sans-serif; font-size: .9rem;
            transition: border-color .2s;
        }
        .login-field input:focus { outline: none; border-color: var(--green-light); }
        .login-err { background: #fef2f2; color: #dc2626; border: 1px solid #fecaca; border-radius: 8px; padding: .6rem 1rem; font-size: .82rem; margin-bottom: 1rem; display: none; }
        .login-btn {
            width: 100%; padding: .85rem;
            background: linear-gradient(135deg, var(--green), var(--green-light));
            color: white; border: none; border-radius: 12px;
            font-family: 'Cairo', sans-serif; font-size: 1rem; font-weight: 700;
            cursor: pointer; box-shadow: 0 4px 20px rgba(46,139,87,.4);
            transition: opacity .2s;
        }
        .login-btn:hover { opacity: .9; }

        /* â”€â”€â”€ MAIN LAYOUT â”€â”€â”€ */
        #appScreen { display: none; }

        .topbar {
            background: linear-gradient(135deg, var(--dark) 0%, var(--green) 100%);
            height: 60px; display: flex; align-items: center; justify-content: space-between;
            padding: 0 1.5rem; position: sticky; top: 0; z-index: 100;
            box-shadow: 0 2px 12px rgba(0,0,0,.3);
        }
        .topbar-title { color: white; font-weight: 900; font-size: 1.05rem; }
        .topbar-sub { color: rgba(255,255,255,.6); font-size: .72rem; }
        .topbar-right { display: flex; gap: .75rem; align-items: center; }
        .topbar-btn {
            background: rgba(255,255,255,.15); border: 1px solid rgba(255,255,255,.25);
            color: white; padding: .4rem .9rem; border-radius: 8px; cursor: pointer;
            font-family: 'Cairo', sans-serif; font-size: .8rem; transition: background .2s;
            text-decoration: none;
        }
        .topbar-btn:hover { background: rgba(255,255,255,.25); }
        .topbar-btn.danger { background: rgba(220,38,38,.3); border-color: rgba(220,38,38,.5); }
        .topbar-btn.danger:hover { background: rgba(220,38,38,.5); }

        /* Tabs nav */
        .tab-nav {
            background: white; border-bottom: 2px solid #e5e7eb;
            display: flex; overflow-x: auto; padding: 0 1rem;
        }
        .tab-nav::-webkit-scrollbar { display: none; }
        .tnav-btn {
            padding: .85rem 1.25rem; border: none; background: none;
            font-family: 'Cairo', sans-serif; font-size: .88rem; font-weight: 600;
            color: #9ca3af; cursor: pointer; white-space: nowrap;
            border-bottom: 3px solid transparent; margin-bottom: -2px;
            transition: all .2s;
        }
        .tnav-btn.active { color: var(--green); border-bottom-color: var(--green); }

        .content { padding: 1.25rem; max-width: 1100px; margin: 0 auto; }

        /* â”€â”€â”€ STAT CARDS â”€â”€â”€ */
        .stats-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(160px, 1fr));
            gap: .75rem; margin-bottom: 1.5rem;
        }
        .stat-card {
            background: white; border-radius: 14px; padding: 1.1rem 1rem;
            box-shadow: 0 2px 8px rgba(0,0,0,.06); border: 1px solid rgba(0,0,0,.05);
            display: flex; align-items: center; justify-content: space-between;
        }
        .stat-num { font-size: 1.75rem; font-weight: 900; line-height: 1; }
        .stat-label { font-size: .7rem; color: #6b7280; font-weight: 600; margin-top: .2rem; }
        .stat-icon { font-size: 1.8rem; }

        /* â”€â”€â”€ CHARTS ROW â”€â”€â”€ */
        .charts-row { display: grid; grid-template-columns: 1fr 1fr; gap: .75rem; margin-bottom: 1.5rem; }
        @media (max-width: 640px) { .charts-row { grid-template-columns: 1fr; } }
        .chart-card { background: white; border-radius: 14px; padding: 1.25rem; box-shadow: 0 2px 8px rgba(0,0,0,.06); }
        .chart-title { font-size: .88rem; font-weight: 700; color: #374151; margin-bottom: 1rem; }

        /* Bar chart (pure CSS) */
        .bar-chart { display: flex; flex-direction: column; gap: .5rem; }
        .bar-row { display: flex; align-items: center; gap: .5rem; font-size: .78rem; }
        .bar-label { width: 75px; text-align: right; color: #6b7280; font-weight: 600; font-size: .72rem; white-space: nowrap; overflow: hidden; text-overflow: ellipsis; }
        .bar-track { flex: 1; height: 20px; background: #f3f4f6; border-radius: 10px; overflow: hidden; }
        .bar-fill { height: 100%; border-radius: 10px; transition: width .6s ease; min-width: 2px; }
        .bar-count { width: 28px; text-align: left; color: #374151; font-weight: 700; font-size: .78rem; }

        /* Donut chart (SVG) */
        .donut-wrap { display: flex; align-items: center; gap: 1.5rem; flex-wrap: wrap; }
        .donut-legend { display: flex; flex-direction: column; gap: .5rem; }
        .legend-item { display: flex; align-items: center; gap: .5rem; font-size: .8rem; color: #374151; }
        .legend-dot { width: 12px; height: 12px; border-radius: 3px; flex-shrink: 0; }

        /* â”€â”€â”€ TABLE SECTION â”€â”€â”€ */
        .section-header {
            display: flex; justify-content: space-between; align-items: center;
            margin-bottom: .75rem; flex-wrap: wrap; gap: .5rem;
        }
        .section-header h3 { font-size: 1rem; font-weight: 700; color: #1f2937; }
        .toolbar { display: flex; gap: .5rem; flex-wrap: wrap; align-items: center; }
        .search-box { position: relative; }
        .search-box input {
            padding: .45rem 1.8rem .45rem .8rem; border: 1.5px solid #e2e8f0; border-radius: 8px;
            font-family: 'Cairo', sans-serif; font-size: .82rem; direction: rtl; width: 180px;
        }
        .search-box input:focus { outline: none; border-color: var(--green-light); }
        .search-icon { position: absolute; right: .5rem; top: 50%; transform: translateY(-50%); color: #9ca3af; font-size: .85rem; }

        .filter-btn {
            padding: .4rem .8rem; border-radius: 20px; border: 1.5px solid #e2e8f0;
            background: white; font-family: 'Cairo', sans-serif; font-size: .75rem;
            font-weight: 600; color: #6b7280; cursor: pointer; transition: all .2s;
        }
        .filter-btn.active { background: var(--green-soft); border-color: var(--green-light); color: var(--green); }
        .print-btn {
            padding: .45rem .9rem; background: var(--green); color: white; border: none;
            border-radius: 8px; font-family: 'Cairo', sans-serif; font-size: .8rem; font-weight: 700;
            cursor: pointer; display: flex; align-items: center; gap: .3rem; transition: background .2s;
        }
        .print-btn:hover { background: var(--green-light); }

        .panel { background: white; border-radius: 14px; box-shadow: 0 2px 8px rgba(0,0,0,.06); overflow: hidden; }
        .table-wrap { overflow-x: auto; }
        table { width: 100%; border-collapse: collapse; font-size: .85rem; }
        th { background: #f8fafc; color: #6b7280; font-weight: 700; font-size: .72rem; text-transform: uppercase; letter-spacing: .04em; padding: .7rem 1rem; text-align: right; border-bottom: 2px solid #f1f5f9; }
        td { padding: .65rem 1rem; border-bottom: 1px solid #f8fafc; color: #374151; text-align: right; }
        tr:hover td { background: #fafafa; }
        .badge { display: inline-block; padding: .18rem .55rem; border-radius: 20px; font-size: .7rem; font-weight: 700; }
        .badge-green { background: #dcfce7; color: #15803d; }
        .badge-yellow { background: #fef9c3; color: #92400e; }
        .badge-village { background: #eff6ff; color: #1d4ed8; }
        .del-btn { background: none; border: none; color: #dc2626; cursor: pointer; font-size: .85rem; padding: .2rem .4rem; border-radius: 4px; transition: background .2s; }
        .del-btn:hover { background: #fef2f2; }

        /* Mobile cards */
        .mobile-cards { display: none; padding: .75rem; }
        @media (max-width: 640px) { .table-wrap { display: none; } .mobile-cards { display: block; } }
        .mc { border: 1px solid #e5e7eb; border-radius: 10px; padding: .875rem; margin-bottom: .65rem; background: white; }
        .mc-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: .4rem; }
        .mc-name { font-weight: 700; color: #111827; }
        .mc-row { display: flex; justify-content: space-between; padding: .28rem 0; border-top: 1px solid #f3f4f6; font-size: .8rem; }
        .mc-lbl { color: #9ca3af; }
        .mc-val { color: #374151; font-weight: 600; }

        /* Loading */
        .loading { padding: 2.5rem; text-align: center; color: #9ca3af; }
        .spinner { display: inline-block; width: 2rem; height: 2rem; border: 3px solid #e5e7eb; border-top-color: var(--green-light); border-radius: 50%; animation: spin .8s linear infinite; }
        @keyframes spin { to { transform: rotate(360deg); } }
        .empty { padding: 2.5rem; text-align: center; color: #9ca3af; font-size: .9rem; }

        /* Confirm dialog */
        .overlay { position: fixed; inset: 0; background: rgba(0,0,0,.5); z-index: 500; display: none; align-items: center; justify-content: center; }
        .overlay.show { display: flex; }
        .confirm-box { background: white; border-radius: 16px; padding: 1.75rem; max-width: 340px; width: 90%; text-align: center; }
        .confirm-box h4 { font-size: 1.1rem; font-weight: 700; margin-bottom: .5rem; }
        .confirm-box p { color: #6b7280; font-size: .85rem; margin-bottom: 1.25rem; }
        .confirm-btns { display: flex; gap: .75rem; justify-content: center; }
        .btn-cancel { padding: .6rem 1.2rem; border: 1.5px solid #e5e7eb; border-radius: 8px; background: white; font-family: 'Cairo', sans-serif; font-weight: 700; cursor: pointer; color: #374151; }
        .btn-delete { padding: .6rem 1.2rem; border: none; border-radius: 8px; background: #dc2626; color: white; font-family: 'Cairo', sans-serif; font-weight: 700; cursor: pointer; }

        /* Print */
        #printTable { display: none; }
        @media print {
            body > *:not(#printTable) { display: none !important; }
            #printTable { display: block !important; padding: 20px; font-family: Cairo, sans-serif; }
            @page { margin: 1cm; size: A4 portrait; }
        }
    </style>
</head>
<body>

<!-- â•â•â• LOGIN â•â•â• -->
<div id="loginScreen">
    <div class="login-card">
        <div class="login-logo">
            <span class="icon">ğŸ”</span>
            <h2>Ù„ÙˆØ­Ø© Ø§Ù„Ø¥Ø¯Ø§Ø±Ø©</h2>
            <p>Ø±Ø§Ø¨Ø·Ø© Ø´Ø¨Ø§Ø¨ Ø¨Ù„Ø¯ÙŠØ© Ù…Ù„Ø²Ù… ØªÙŠØ´Ø·</p>
        </div>
        <div class="login-err" id="loginErr">ÙƒÙ„Ù…Ø© Ø§Ù„Ù…Ø±ÙˆØ± ØºÙŠØ± ØµØ­ÙŠØ­Ø©</div>
        <div class="login-field">
            <label>ÙƒÙ„Ù…Ø© Ø§Ù„Ù…Ø±ÙˆØ±</label>
            <input type="password" id="pwdInput" placeholder="â€¢â€¢â€¢â€¢â€¢â€¢â€¢â€¢" onkeydown="if(event.key==='Enter')doLogin()">
        </div>
        <button class="login-btn" onclick="doLogin()">ğŸ”“ Ø¯Ø®ÙˆÙ„</button>
    </div>
</div>

<!-- â•â•â• APP â•â•â• -->
<div id="appScreen">
    <div class="topbar">
        <div>
            <div class="topbar-title">ğŸ›¡ï¸ Ù„ÙˆØ­Ø© Ø§Ù„Ø¥Ø¯Ø§Ø±Ø©</div>
            <div class="topbar-sub">Ø±Ø§Ø¨Ø·Ø© Ø´Ø¨Ø§Ø¨ Ø¨Ù„Ø¯ÙŠØ© Ù…Ù„Ø²Ù… ØªÙŠØ´Ø·</div>
        </div>
        <div class="topbar-right">
            <a href="/" class="topbar-btn">â† Ø§Ù„Ø±Ø¦ÙŠØ³ÙŠØ©</a>
            <button class="topbar-btn danger" onclick="logout()">Ø®Ø±ÙˆØ¬</button>
        </div>
    </div>

    <div class="tab-nav">
        <button class="tnav-btn active" onclick="showSection('stats')">ğŸ“Š Ø§Ù„Ø¥Ø­ØµØ§Ø¡Ø§Øª</button>
        <button class="tnav-btn" onclick="showSection('hommes')">ğŸ‘¨ Ø§Ù„Ø±Ø¬Ø§Ù„</button>
        <button class="tnav-btn" onclick="showSection('femmes')">ğŸ‘© Ø§Ù„Ù†Ø³Ø§Ø¡</button>
    </div>

    <div class="content">

        <!-- â”€â”€ STATS SECTION â”€â”€ -->
        <div id="secStats">
            <div class="stats-grid">
                <div class="stat-card">
                    <div><div class="stat-num" id="sHommes" style="color:#16a34a">â€”</div><div class="stat-label">Ø¥Ø¬Ù…Ø§Ù„ÙŠ Ø§Ù„Ø±Ø¬Ø§Ù„</div></div>
                    <div class="stat-icon">ğŸ‘¨</div>
                </div>
                <div class="stat-card">
                    <div><div class="stat-num" id="sFemmes" style="color:#be185d">â€”</div><div class="stat-label">Ø¥Ø¬Ù…Ø§Ù„ÙŠ Ø§Ù„Ù†Ø³Ø§Ø¡</div></div>
                    <div class="stat-icon">ğŸ‘©</div>
                </div>
                <div class="stat-card">
                    <div><div class="stat-num" id="sTotal" style="color:#2563eb">â€”</div><div class="stat-label">Ø¥Ø¬Ù…Ø§Ù„ÙŠ Ø§Ù„Ø£Ø¹Ø¶Ø§Ø¡</div></div>
                    <div class="stat-icon">ğŸ‘¥</div>
                </div>
                <div class="stat-card">
                    <div><div class="stat-num" id="sTravaille" style="color:#16a34a">â€”</div><div class="stat-label">ÙŠØ¹Ù…Ù„ÙˆÙ†</div></div>
                    <div class="stat-icon">ğŸ’¼</div>
                </div>
                <div class="stat-card">
                    <div><div class="stat-num" id="sChomage" style="color:#dc2626">â€”</div><div class="stat-label">Ø¨Ø¯ÙˆÙ† Ø¹Ù…Ù„</div></div>
                    <div class="stat-icon">ğŸ </div>
                </div>
                <div class="stat-card">
                    <div><div class="stat-num" id="sAuj" style="color:#7c3aed">â€”</div><div class="stat-label">ØªØ³Ø¬ÙŠÙ„ Ø§Ù„ÙŠÙˆÙ…</div></div>
                    <div class="stat-icon">ğŸ“…</div>
                </div>
            </div>

            <div class="charts-row">
                <!-- Villages hommes -->
                <div class="chart-card">
                    <div class="chart-title">ğŸ˜ï¸ Ø§Ù„Ø±Ø¬Ø§Ù„ Ø­Ø³Ø¨ Ø§Ù„Ù‚Ø±ÙŠØ©</div>
                    <div class="bar-chart" id="chartVillagesH"></div>
                </div>
                <!-- Villages femmes -->
                <div class="chart-card">
                    <div class="chart-title">ğŸ˜ï¸ Ø§Ù„Ù†Ø³Ø§Ø¡ Ø­Ø³Ø¨ Ø§Ù„Ù‚Ø±ÙŠØ©</div>
                    <div class="bar-chart" id="chartVillagesF"></div>
                </div>
                <!-- Age hommes -->
                <div class="chart-card">
                    <div class="chart-title">ğŸ“Š Ø§Ù„Ø±Ø¬Ø§Ù„ Ø­Ø³Ø¨ Ø§Ù„ÙØ¦Ø© Ø§Ù„Ø¹Ù…Ø±ÙŠØ©</div>
                    <div class="bar-chart" id="chartAgeH"></div>
                </div>
                <!-- Travaille donut -->
                <div class="chart-card">
                    <div class="chart-title">ğŸ’¼ ÙˆØ¶Ø¹ Ø§Ù„ØªØ´ØºÙŠÙ„ (Ø±Ø¬Ø§Ù„)</div>
                    <div class="donut-wrap">
                        <svg width="100" height="100" viewBox="0 0 36 36" id="donutSvg">
                            <circle cx="18" cy="18" r="15.9155" fill="transparent" stroke="#e5e7eb" stroke-width="3.5"/>
                            <circle cx="18" cy="18" r="15.9155" fill="transparent" stroke="#16a34a" stroke-width="3.5"
                                stroke-dasharray="0 100" stroke-dashoffset="25" stroke-linecap="round"
                                id="donutGreen" style="transition:stroke-dasharray .8s ease"/>
                            <circle cx="18" cy="18" r="15.9155" fill="transparent" stroke="#fbbf24" stroke-width="3.5"
                                stroke-dasharray="0 100" stroke-dashoffset="25"
                                id="donutYellow" style="transition:stroke-dasharray .8s ease"/>
                        </svg>
                        <div class="donut-legend">
                            <div class="legend-item"><div class="legend-dot" style="background:#16a34a"></div><span id="donutLblOui">ÙŠØ¹Ù…Ù„ÙˆÙ†: â€”</span></div>
                            <div class="legend-item"><div class="legend-dot" style="background:#fbbf24"></div><span id="donutLblNon">Ø¨Ø¯ÙˆÙ† Ø¹Ù…Ù„: â€”</span></div>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- â”€â”€ HOMMES SECTION â”€â”€ -->
        <div id="secHommes" style="display:none">
            <div class="section-header">
                <h3>ğŸ‘¨ Ø§Ù„Ø±Ø¬Ø§Ù„ Ø§Ù„Ù…Ø³Ø¬Ù„ÙˆÙ†</h3>
                <div class="toolbar">
                    <div class="search-box">
                        <span class="search-icon">ğŸ”</span>
                        <input type="text" id="searchH" placeholder="Ø¨Ø­Ø«..." oninput="renderHommes()">
                    </div>
                    <button class="filter-btn active" onclick="setFilterH('all',this)">Ø§Ù„ÙƒÙ„</button>
                    <button class="filter-btn" onclick="setFilterH('travaille',this)">ğŸ’¼ ÙŠØ¹Ù…Ù„ÙˆÙ†</button>
                    <button class="filter-btn" onclick="setFilterH('chomage',this)">ğŸ  Ø¨Ø¯ÙˆÙ† Ø¹Ù…Ù„</button>
                    <button class="print-btn" onclick="printTable('hommes')">ğŸ–¨ï¸ Ø·Ø¨Ø§Ø¹Ø©</button>
                </div>
            </div>
            <div class="panel">
                <div class="table-wrap">
                    <table dir="rtl">
                        <thead><tr>
                            <th>#</th><th>Ø§Ù„Ø§Ø³Ù… ÙˆØ§Ù„Ù„Ù‚Ø¨</th><th>Ø§Ù„Ù‡Ø§ØªÙ</th>
                            <th>Ø§Ù„Ù‚Ø±ÙŠØ©</th><th>Ø§Ù„Ø¹Ù…Ø±</th><th>Ø§Ù„ÙˆØ¶Ø¹</th><th>Ø§Ù„ØªØ§Ø±ÙŠØ®</th><th></th>
                        </tr></thead>
                        <tbody id="hBody"></tbody>
                    </table>
                </div>
                <div id="hMobile" class="mobile-cards"></div>
            </div>
        </div>

        <!-- â”€â”€ FEMMES SECTION â”€â”€ -->
        <div id="secFemmes" style="display:none">
            <div class="section-header">
                <h3>ğŸ‘© Ø§Ù„Ù†Ø³Ø§Ø¡ Ø§Ù„Ù…Ø³Ø¬Ù„Ø§Øª</h3>
                <div class="toolbar">
                    <div class="search-box">
                        <span class="search-icon">ğŸ”</span>
                        <input type="text" id="searchF" placeholder="Ø¨Ø­Ø«..." oninput="renderFemmes()">
                    </div>
                    <button class="print-btn" onclick="printTable('femmes')">ğŸ–¨ï¸ Ø·Ø¨Ø§Ø¹Ø©</button>
                </div>
            </div>
            <div class="panel">
                <div class="table-wrap">
                    <table dir="rtl">
                        <thead><tr>
                            <th>#</th><th>Ø§Ù„Ø§Ø³Ù… ÙˆØ§Ù„Ù„Ù‚Ø¨</th><th>Ø§Ù„Ù‡Ø§ØªÙ</th>
                            <th>Ø§Ù„Ù‚Ø±ÙŠØ©</th><th>Ø§Ù„Ø¹Ù…Ø±</th><th>Ø§Ù„ØªØ§Ø±ÙŠØ®</th><th></th>
                        </tr></thead>
                        <tbody id="fBody"></tbody>
                    </table>
                </div>
                <div id="fMobile" class="mobile-cards"></div>
            </div>
        </div>

    </div><!-- /content -->
</div><!-- /appScreen -->

<!-- Confirm delete -->
<div class="overlay" id="confirmOverlay">
    <div class="confirm-box">
        <h4>âš ï¸ ØªØ£ÙƒÙŠØ¯ Ø§Ù„Ø­Ø°Ù</h4>
        <p id="confirmMsg">Ù‡Ù„ Ø£Ù†Øª Ù…ØªØ£ÙƒØ¯ Ù…Ù† Ø­Ø°Ù Ù‡Ø°Ø§ Ø§Ù„Ø¹Ø¶ÙˆØŸ</p>
        <div class="confirm-btns">
            <button class="btn-cancel" onclick="closeConfirm()">Ø¥Ù„ØºØ§Ø¡</button>
            <button class="btn-delete" onclick="confirmDelete()">Ø­Ø°Ù</button>
        </div>
    </div>
</div>

<div id="printTable"></div>

<script>
// â”€â”€ AUTH â”€â”€
const ADMIN_PWD = 'admin2026'; // changez ce mot de passe !
let authed = false;

function doLogin() {
    const pwd = document.getElementById('pwdInput').value;
    if (pwd === ADMIN_PWD) {
        authed = true;
        document.getElementById('loginScreen').style.display = 'none';
        document.getElementById('appScreen').style.display = 'block';
        loadAll();
    } else {
        document.getElementById('loginErr').style.display = 'block';
        document.getElementById('pwdInput').value = '';
    }
}
function logout() {
    authed = false;
    document.getElementById('loginScreen').style.display = 'flex';
    document.getElementById('appScreen').style.display = 'none';
}

// â”€â”€ TABS â”€â”€
function showSection(s) {
    ['Stats','Hommes','Femmes'].forEach(n => {
        document.getElementById('sec'+n).style.display = s === n.toLowerCase() ? 'block' : 'none';
    });
    document.querySelectorAll('.tnav-btn').forEach((b,i) => {
        b.classList.toggle('active', ['stats','hommes','femmes'][i] === s);
    });
}

// â”€â”€ DATA â”€â”€
let hommesData = [], femmesData = [];
let filterH = 'all';
let deleteTarget = null, deleteType = null;

async function loadAll() {
    try {
        const [r1,r2] = await Promise.all([fetch('/api/membres'), fetch('/api/femmes')]);
        const d1 = await r1.json(), d2 = await r2.json();
        hommesData = d1.membres || [];
        femmesData = d2.femmes || [];
        buildStats();
        renderHommes();
        renderFemmes();
    } catch(e) { console.error(e); }
}

// â”€â”€ STATS â”€â”€
function buildStats() {
    const h = hommesData, f = femmesData;
    const travaille = h.filter(m => m.situation === 'Ù†Ø¹Ù…').length;
    const chomage = h.length - travaille;
    const today = new Date().toDateString();
    const auj = [...h,...f].filter(m => new Date(m.date_inscription).toDateString() === today).length;

    document.getElementById('sHommes').textContent = h.length;
    document.getElementById('sFemmes').textContent = f.length;
    document.getElementById('sTotal').textContent = h.length + f.length;
    document.getElementById('sTravaille').textContent = travaille;
    document.getElementById('sChomage').textContent = chomage;
    document.getElementById('sAuj').textContent = auj;

    // Villages hommes
    buildBarChart('chartVillagesH', countBy(h, 'village'), '#2e8b57');
    // Villages femmes
    buildBarChart('chartVillagesF', countBy(f, 'village'), '#be185d');
    // Age hommes
    buildBarChart('chartAgeH', countBy(h, 'age'), '#7c3aed');
    // Donut
    const pct = h.length ? Math.round((travaille / h.length) * 100) : 0;
    const offset = 25;
    document.getElementById('donutGreen').setAttribute('stroke-dasharray', `${pct} ${100-pct}`);
    document.getElementById('donutYellow').setAttribute('stroke-dasharray', `${100-pct} ${pct}`);
    document.getElementById('donutYellow').setAttribute('stroke-dashoffset', 25 - pct);
    document.getElementById('donutLblOui').textContent = `ÙŠØ¹Ù…Ù„ÙˆÙ†: ${travaille} (${pct}%)`;
    document.getElementById('donutLblNon').textContent = `Ø¨Ø¯ÙˆÙ† Ø¹Ù…Ù„: ${chomage} (${100-pct}%)`;
}

function countBy(arr, key) {
    const map = {};
    arr.forEach(m => { const v = m[key] || 'ØºÙŠØ± Ù…Ø­Ø¯Ø¯'; map[v] = (map[v]||0)+1; });
    return Object.entries(map).sort((a,b) => b[1]-a[1]);
}

const COLORS = ['#2e8b57','#16a34a','#059669','#0d9488','#0891b2','#7c3aed','#be185d','#dc2626'];
function buildBarChart(id, entries, color) {
    const el = document.getElementById(id);
    if (!entries.length) { el.innerHTML = '<p style="color:#9ca3af;font-size:.8rem;text-align:center">Ù„Ø§ ØªÙˆØ¬Ø¯ Ø¨ÙŠØ§Ù†Ø§Øª</p>'; return; }
    const max = entries[0][1];
    el.innerHTML = entries.map(([label, count], i) => `
        <div class="bar-row">
            <div class="bar-label" title="${label}">${label}</div>
            <div class="bar-track">
                <div class="bar-fill" style="width:${max ? (count/max*100) : 0}%; background:${COLORS[i % COLORS.length]}"></div>
            </div>
            <div class="bar-count">${count}</div>
        </div>
    `).join('');
}

// â”€â”€ RENDER TABLES â”€â”€
function fmtDate(d) {
    if (!d) return 'â€”';
    return new Date(d).toLocaleDateString('fr-FR', {year:'numeric',month:'short',day:'numeric'});
}

function getFilteredH() {
    let data = hommesData;
    const q = document.getElementById('searchH')?.value.toLowerCase() || '';
    if (q) data = data.filter(m => m.nom?.toLowerCase().includes(q) || m.village?.toLowerCase().includes(q) || m.telephone?.includes(q));
    if (filterH === 'travaille') data = data.filter(m => m.situation === 'Ù†Ø¹Ù…');
    if (filterH === 'chomage') data = data.filter(m => m.situation !== 'Ù†Ø¹Ù…');
    return data;
}

function renderHommes() {
    const data = getFilteredH();
    const tbody = document.getElementById('hBody');
    const mobile = document.getElementById('hMobile');
    if (!data.length) {
        tbody.innerHTML = '<tr><td colspan="8" class="empty">Ù„Ø§ ØªÙˆØ¬Ø¯ Ù†ØªØ§Ø¦Ø¬</td></tr>';
        mobile.innerHTML = '<div class="empty">Ù„Ø§ ØªÙˆØ¬Ø¯ Ù†ØªØ§Ø¦Ø¬</div>'; return;
    }
    tbody.innerHTML = data.map((m,i) => `
        <tr>
            <td style="color:#9ca3af">${i+1}</td>
            <td><strong>${m.nom}</strong></td>
            <td>${m.telephone||'â€”'}</td>
            <td><span class="badge badge-village">${m.village||'â€”'}</span></td>
            <td>${m.age||'â€”'}</td>
            <td><span class="badge ${m.situation==='Ù†Ø¹Ù…'?'badge-green':'badge-yellow'}">${m.situation==='Ù†Ø¹Ù…'?'ğŸ’¼ ÙŠØ¹Ù…Ù„':'ğŸ  Ø¨Ø¯ÙˆÙ† Ø¹Ù…Ù„'}</span></td>
            <td style="color:#9ca3af;font-size:.78rem">${fmtDate(m.date_inscription)}</td>
            <td><button class="del-btn" onclick="askDelete(${m.id},'hommes','${m.nom.replace(/'/g,"\\'")}')">ğŸ—‘ï¸</button></td>
        </tr>
    `).join('');
    mobile.innerHTML = data.map((m,i) => `
        <div class="mc">
            <div class="mc-header">
                <span class="mc-name">${i+1}. ${m.nom}</span>
                <span class="badge ${m.situation==='Ù†Ø¹Ù…'?'badge-green':'badge-yellow'}">${m.situation==='Ù†Ø¹Ù…'?'ğŸ’¼ ÙŠØ¹Ù…Ù„':'ğŸ  Ø¨Ø¯ÙˆÙ† Ø¹Ù…Ù„'}</span>
            </div>
            <div class="mc-row"><span class="mc-lbl">Ø§Ù„Ù‡Ø§ØªÙ</span><span class="mc-val">${m.telephone||'â€”'}</span></div>
            <div class="mc-row"><span class="mc-lbl">Ø§Ù„Ù‚Ø±ÙŠØ©</span><span class="mc-val">${m.village||'â€”'}</span></div>
            <div class="mc-row"><span class="mc-lbl">Ø§Ù„Ø¹Ù…Ø±</span><span class="mc-val">${m.age||'â€”'}</span></div>
            <div class="mc-row"><span class="mc-lbl">Ø§Ù„ØªØ§Ø±ÙŠØ®</span><span class="mc-val">${fmtDate(m.date_inscription)}</span></div>
            <div style="text-align:left;margin-top:.5rem">
                <button class="del-btn" onclick="askDelete(${m.id},'hommes','${m.nom.replace(/'/g,"\\'")}')">ğŸ—‘ï¸ Ø­Ø°Ù</button>
            </div>
        </div>
    `).join('');
}

function renderFemmes() {
    const q = document.getElementById('searchF')?.value.toLowerCase() || '';
    let data = femmesData;
    if (q) data = data.filter(m => m.nom?.toLowerCase().includes(q) || m.village?.toLowerCase().includes(q));
    const tbody = document.getElementById('fBody');
    const mobile = document.getElementById('fMobile');
    if (!data.length) {
        tbody.innerHTML = '<tr><td colspan="7" class="empty">Ù„Ø§ ØªÙˆØ¬Ø¯ Ù†ØªØ§Ø¦Ø¬</td></tr>';
        mobile.innerHTML = '<div class="empty">Ù„Ø§ ØªÙˆØ¬Ø¯ Ù†ØªØ§Ø¦Ø¬</div>'; return;
    }
    tbody.innerHTML = data.map((m,i) => `
        <tr>
            <td style="color:#9ca3af">${i+1}</td>
            <td><strong>${m.nom}</strong></td>
            <td>${m.telephone||'â€”'}</td>
            <td><span class="badge badge-village">${m.village||'â€”'}</span></td>
            <td>${m.age||'â€”'}</td>
            <td style="color:#9ca3af;font-size:.78rem">${fmtDate(m.date_inscription)}</td>
            <td><button class="del-btn" onclick="askDelete(${m.id},'femmes','${m.nom.replace(/'/g,"\\'")}')">ğŸ—‘ï¸</button></td>
        </tr>
    `).join('');
    mobile.innerHTML = data.map((m,i) => `
        <div class="mc">
            <div class="mc-header"><span class="mc-name">${i+1}. ${m.nom}</span><span style="font-size:1.2rem">ğŸ‘©</span></div>
            <div class="mc-row"><span class="mc-lbl">Ø§Ù„Ù‡Ø§ØªÙ</span><span class="mc-val">${m.telephone||'â€”'}</span></div>
            <div class="mc-row"><span class="mc-lbl">Ø§Ù„Ù‚Ø±ÙŠØ©</span><span class="mc-val">${m.village||'â€”'}</span></div>
            <div class="mc-row"><span class="mc-lbl">Ø§Ù„Ø¹Ù…Ø±</span><span class="mc-val">${m.age||'â€”'}</span></div>
            <div class="mc-row"><span class="mc-lbl">Ø§Ù„ØªØ§Ø±ÙŠØ®</span><span class="mc-val">${fmtDate(m.date_inscription)}</span></div>
            <div style="text-align:left;margin-top:.5rem">
                <button class="del-btn" onclick="askDelete(${m.id},'femmes','${m.nom.replace(/'/g,"\\'")}')">ğŸ—‘ï¸ Ø­Ø°Ù</button>
            </div>
        </div>
    `).join('');
}

function setFilterH(f, btn) {
    filterH = f;
    document.querySelectorAll('#secHommes .filter-btn').forEach(b => b.classList.remove('active'));
    btn.classList.add('active');
    renderHommes();
}

// â”€â”€ DELETE â”€â”€
function askDelete(id, type, nom) {
    deleteTarget = id; deleteType = type;
    document.getElementById('confirmMsg').textContent = `Ù‡Ù„ Ø£Ù†Øª Ù…ØªØ£ÙƒØ¯ Ù…Ù† Ø­Ø°Ù "${nom}"ØŸ Ù„Ø§ ÙŠÙ…ÙƒÙ† Ø§Ù„ØªØ±Ø§Ø¬Ø¹.`;
    document.getElementById('confirmOverlay').classList.add('show');
}
function closeConfirm() { document.getElementById('confirmOverlay').classList.remove('show'); deleteTarget = null; }
async function confirmDelete() {
    if (!deleteTarget) return;
    const url = deleteType === 'hommes' ? `/api/membres/${deleteTarget}` : `/api/femmes/${deleteTarget}`;
    try {
        const res = await fetch(url, { method: 'DELETE' });
        const r = await res.json();
        if (r.success) { await loadAll(); closeConfirm(); }
    } catch(e) { alert('Ø®Ø·Ø£ ÙÙŠ Ø§Ù„Ø­Ø°Ù'); }
}

// â”€â”€ PRINT â”€â”€
function printTable(type) {
    const data = type === 'hommes' ? getFilteredH() : femmesData;
    const isH = type === 'hommes';
    const now = new Date();
    const dateStr = now.toLocaleDateString('fr-FR', {weekday:'long',year:'numeric',month:'long',day:'numeric'});
    let html = `<div style="padding:20px;font-family:Cairo,sans-serif;">
        <div style="text-align:center;margin-bottom:24px;padding-bottom:16px;border-bottom:3px double #1a5c38;">
            <h1 style="font-size:20pt;font-weight:900;color:#1a5c38;margin-bottom:4px;">Ø±Ø§Ø¨Ø·Ø© Ø´Ø¨Ø§Ø¨ Ø¨Ù„Ø¯ÙŠØ© Ù…Ù„Ø²Ù… ØªÙŠØ´Ø·</h1>
            <p style="color:#888;font-size:9pt;">Association de la Jeunesse de Melzam Tichit â€” Mauritanie</p>
            <p style="color:#aaa;font-size:8pt;margin-top:4px;">Ø·ÙØ¨Ø¹ Ø¨ØªØ§Ø±ÙŠØ®: ${dateStr}</p>
        </div>
        <h2 style="font-size:13pt;font-weight:700;text-align:center;margin-bottom:14px;color:#333;">
            ${isH ? 'Ù‚Ø§Ø¦Ù…Ø© Ø§Ù„Ø±Ø¬Ø§Ù„ Ø§Ù„Ù…Ø³Ø¬Ù„ÙŠÙ†' : 'Ù‚Ø§Ø¦Ù…Ø© Ø§Ù„Ù†Ø³Ø§Ø¡ Ø§Ù„Ù…Ø³Ø¬Ù„Ø§Øª'} (${data.length} Ø¹Ø¶Ùˆ)
        </h2>
        <table style="width:100%;border-collapse:collapse;font-size:9pt;" dir="rtl">
            <thead><tr style="background:#e8f5ee;">
                <th style="border:1px solid #ccc;padding:6px;">#</th>
                <th style="border:1px solid #ccc;padding:6px;">Ø§Ù„Ø§Ø³Ù… ÙˆØ§Ù„Ù„Ù‚Ø¨</th>
                <th style="border:1px solid #ccc;padding:6px;">Ø§Ù„Ù‡Ø§ØªÙ</th>
                <th style="border:1px solid #ccc;padding:6px;">Ø§Ù„Ù‚Ø±ÙŠØ©</th>
                <th style="border:1px solid #ccc;padding:6px;">Ø§Ù„Ø¹Ù…Ø±</th>
                ${isH ? '<th style="border:1px solid #ccc;padding:6px;">Ø§Ù„ÙˆØ¶Ø¹</th>' : ''}
                <th style="border:1px solid #ccc;padding:6px;">Ø§Ù„ØªØ§Ø±ÙŠØ®</th>
            </tr></thead>
            <tbody>`;
    data.forEach((m,i) => {
        html += `<tr>
            <td style="border:1px solid #ddd;padding:5px;text-align:center;">${i+1}</td>
            <td style="border:1px solid #ddd;padding:5px;font-weight:600;">${m.nom}</td>
            <td style="border:1px solid #ddd;padding:5px;">${m.telephone||'â€”'}</td>
            <td style="border:1px solid #ddd;padding:5px;">${m.village||'â€”'}</td>
            <td style="border:1px solid #ddd;padding:5px;">${m.age||'â€”'}</td>
            ${isH ? `<td style="border:1px solid #ddd;padding:5px;">${m.situation==='Ù†Ø¹Ù…'?'ÙŠØ¹Ù…Ù„':'Ø¨Ø¯ÙˆÙ† Ø¹Ù…Ù„'}</td>` : ''}
            <td style="border:1px solid #ddd;padding:5px;font-size:8pt;">${fmtDate(m.date_inscription)}</td>
        </tr>`;
    });
    html += `</tbody></table></div>`;
    document.getElementById('printTable').innerHTML = html;
    setTimeout(() => window.print(), 100);
}
</script>
</body>
</html>