<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Gestion des DÃ©penses - Admin</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Cairo:wght@400;600;700;800&display=swap" rel="stylesheet">
    <style>
        body { font-family: 'Cairo', sans-serif; }
        .gradient-bg { background: linear-gradient(135deg, #065f46 0%, #10b981 100%); }
        .balance-card {
            background: linear-gradient(135deg, #064e3b 0%, #065f46 50%, #047857 100%);
            position: relative; overflow: hidden;
        }
        .balance-card::before {
            content: ''; position: absolute; top: -50%; right: -50%;
            width: 200%; height: 200%;
            background: radial-gradient(circle, rgba(255,255,255,0.05) 0%, transparent 70%);
            animation: shimmer 4s ease-in-out infinite;
        }
        @keyframes shimmer { 0%,100%{transform:translate(0,0)} 50%{transform:translate(-10%,10%)} }
        .expense-card { transition: all 0.3s ease; animation: slideIn 0.3s ease; }
        @keyframes slideIn { from{opacity:0;transform:translateY(-10px)} to{opacity:1;transform:translateY(0)} }
        .expense-card:hover { transform: translateX(-4px); box-shadow: 0 8px 25px rgba(0,0,0,0.1); }
        .delete-btn { transition: all 0.2s; }
        .delete-btn:hover { transform: scale(1.1); }
        .modal-overlay { backdrop-filter: blur(4px); }
        .progress-bar { transition: width 0.8s cubic-bezier(0.4,0,0.2,1); }
    </style>
</head>
<body class="bg-gray-50 min-h-screen flex flex-col">

    <!-- Header -->
    <div class="gradient-bg text-white py-6 md:py-8 shadow-lg">
        <div class="container mx-auto px-4 flex flex-col md:flex-row justify-between items-center gap-4">
            <div class="text-center md:text-right">
                <h1 class="text-xl md:text-2xl font-bold">Gestion des DÃ©penses (Ø¥Ø¯Ø§Ø±Ø© Ø§Ù„Ù…ØµØ±ÙˆÙØ§Øª)</h1>
                <p class="text-green-100 text-xs md:text-sm">Administration</p>
            </div>
            <a href="/admin.html" class="bg-white/20 hover:bg-white/30 text-white px-4 py-2 rounded-lg font-bold text-sm backdrop-blur-sm transition border border-white/20">
                â† Retour Dashboard
            </a>
        </div>
    </div>

    <!-- Tableau de bord financier -->
    <div class="container mx-auto px-3 md:px-4 pt-6">
        <div class="balance-card rounded-2xl shadow-2xl p-6 md:p-8 text-white">
            <div class="relative z-10">
                <div class="grid grid-cols-1 md:grid-cols-3 gap-6 text-center">
                    <div>
                        <p class="text-green-200 text-xs uppercase tracking-wider mb-1">Ø¥Ø¬Ù…Ø§Ù„ÙŠ Ø§Ù„Ø§Ø´ØªØ±Ø§ÙƒØ§Øª Ø§Ù„Ù…Ø­ØµÙ„Ø©</p>
                        <p class="text-4xl font-extrabold text-white" id="totalCotisations">â€”</p>
                        <p class="text-green-300 text-xs mt-1">MRO</p>
                    </div>
                    <div class="border-t md:border-t-0 md:border-x border-white/20 pt-4 md:pt-0 md:px-6">
                        <p class="text-red-200 text-xs uppercase tracking-wider mb-1">Ø¥Ø¬Ù…Ø§Ù„ÙŠ Ø§Ù„Ù…ØµØ±ÙˆÙØ§Øª</p>
                        <p class="text-4xl font-extrabold text-red-300" id="totalDepenses">â€”</p>
                        <p class="text-red-200 text-xs mt-1">MRO</p>
                    </div>
                    <div class="border-t md:border-t-0 border-white/20 pt-4 md:pt-0">
                        <p class="text-yellow-200 text-xs uppercase tracking-wider mb-1">Ø§Ù„Ø±ØµÙŠØ¯ Ø§Ù„Ù…ØªØ¨Ù‚ÙŠ</p>
                        <p class="text-4xl font-extrabold text-yellow-300" id="solde">â€”</p>
                        <p class="text-yellow-200 text-xs mt-1">MRO</p>
                    </div>
                </div>
                <div class="mt-6">
                    <div class="flex justify-between text-xs text-green-200 mb-2">
                        <span>Ù†Ø³Ø¨Ø© Ø§Ù„Ø¥Ù†ÙØ§Ù‚ / Taux de dÃ©pense</span>
                        <span id="depenseRate">0%</span>
                    </div>
                    <div class="bg-white/20 rounded-full h-3 overflow-hidden">
                        <div id="depenseProgressBar" class="h-full rounded-full progress-bar bg-gradient-to-r from-green-400 to-yellow-400" style="width:0%"></div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Contenu principal -->
    <div class="container mx-auto px-3 md:px-4 py-6 flex-grow">
        <div class="grid md:grid-cols-2 gap-6">

            <!-- FORMULAIRE AJOUT -->
            <div class="bg-white rounded-2xl shadow-lg p-6">
                <h2 class="text-xl font-bold text-gray-800 mb-5 text-right border-b pb-3">
                    â• Ø¥Ø¶Ø§ÙØ© Ù…ØµØ±ÙˆÙ Ø¬Ø¯ÙŠØ¯
                    <span class="block text-sm font-normal text-gray-500 mt-1">Ajouter une nouvelle dÃ©pense</span>
                </h2>
                <div class="space-y-4">
                    <div>
                        <label class="block text-sm font-bold text-gray-700 mb-1 text-right">Ø§Ù„ÙˆØµÙ / Description *</label>
                        <input type="text" id="depenseLabel" placeholder="Ù…Ø«Ø§Ù„: Ø¥ÙŠØ¬Ø§Ø± Ø§Ù„Ù‚Ø§Ø¹Ø©"
                            class="w-full px-4 py-3 border-2 border-gray-200 rounded-lg focus:border-green-500 focus:outline-none transition text-right font-medium" />
                    </div>
                    <div>
                        <label class="block text-sm font-bold text-gray-700 mb-1 text-right">Ø§Ù„Ù…Ø¨Ù„Øº / Montant (MRO) *</label>
                        <input type="number" id="depenseMontant" placeholder="0" min="1"
                            class="w-full px-4 py-3 border-2 border-gray-200 rounded-lg focus:border-green-500 focus:outline-none transition text-right font-medium text-lg" />
                    </div>
                    <div>
                        <label class="block text-sm font-bold text-gray-700 mb-1 text-right">Ø§Ù„ÙØ¦Ø© / CatÃ©gorie</label>
                        <select id="depenseCategorie" class="w-full px-4 py-3 border-2 border-gray-200 rounded-lg focus:border-green-500 focus:outline-none transition text-right font-medium bg-white">
                            <option value="administration">ğŸ¢ Ø¥Ø¯Ø§Ø±Ø© / Administration</option>
                            <option value="evenement">ğŸ‰ ÙØ¹Ø§Ù„ÙŠØ© / Ã‰vÃ©nement</option>
                            <option value="transport">ğŸš— Ù†Ù‚Ù„ / Transport</option>
                            <option value="restauration">ğŸ½ï¸ ØªØºØ°ÙŠØ© / Restauration</option>
                            <option value="materiel">ğŸ› ï¸ Ù…Ø¹Ø¯Ø§Øª / MatÃ©riel</option>
                            <option value="autre">ğŸ“¦ Ø£Ø®Ø±Ù‰ / Autre</option>
                        </select>
                    </div>
                    <div>
                        <label class="block text-sm font-bold text-gray-700 mb-1 text-right">Ø§Ù„ØªØ§Ø±ÙŠØ® / Date</label>
                        <input type="date" id="depenseDate" class="w-full px-4 py-3 border-2 border-gray-200 rounded-lg focus:border-green-500 focus:outline-none transition text-right font-medium" />
                    </div>
                    <div>
                        <label class="block text-sm font-bold text-gray-700 mb-1 text-right">Ù…Ù„Ø§Ø­Ø¸Ø© / Note (facultatif)</label>
                        <textarea id="depenseNote" rows="2" placeholder="ØªÙØ§ØµÙŠÙ„ Ø¥Ø¶Ø§ÙÙŠØ©..."
                            class="w-full px-4 py-3 border-2 border-gray-200 rounded-lg focus:border-green-500 focus:outline-none transition text-right font-medium resize-none"></textarea>
                    </div>
                    <button onclick="addDepense()" id="saveBtn"
                        class="w-full bg-gradient-to-r from-green-600 to-green-500 text-white py-3 px-6 rounded-lg font-bold text-lg hover:from-green-700 hover:to-green-600 transition shadow-lg hover:shadow-xl transform hover:-translate-y-0.5">
                        âœ… ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ù…ØµØ±ÙˆÙ / Enregistrer
                    </button>
                </div>
            </div>

            <!-- LISTE DES DÃ‰PENSES -->
            <div class="bg-white rounded-2xl shadow-lg p-6">
                <div class="flex items-center justify-between mb-5 border-b pb-3">
                    <button onclick="clearAll()" class="text-xs text-red-400 hover:text-red-600 font-medium transition">ğŸ—‘ï¸ Effacer tout</button>
                    <h2 class="text-xl font-bold text-gray-800 text-right">
                        ğŸ“‹ Ø³Ø¬Ù„ Ø§Ù„Ù…ØµØ±ÙˆÙØ§Øª
                        <span class="block text-sm font-normal text-gray-500 mt-1">Historique des dÃ©penses</span>
                    </h2>
                </div>
                <div class="mb-4">
                    <select id="filterCategorie" onchange="renderDepenses()" class="w-full px-3 py-2 border border-gray-200 rounded-lg text-sm text-right focus:border-green-500 focus:outline-none bg-white">
                        <option value="">ğŸ” ÙƒÙ„ Ø§Ù„ÙØ¦Ø§Øª / Toutes catÃ©gories</option>
                        <option value="administration">ğŸ¢ Administration</option>
                        <option value="evenement">ğŸ‰ Ã‰vÃ©nement</option>
                        <option value="transport">ğŸš— Transport</option>
                        <option value="restauration">ğŸ½ï¸ Restauration</option>
                        <option value="materiel">ğŸ› ï¸ MatÃ©riel</option>
                        <option value="autre">ğŸ“¦ Autre</option>
                    </select>
                </div>
                <div id="depensesList" class="space-y-3 max-h-[450px] overflow-y-auto pr-1">
                    <div class="text-center text-gray-400 py-8"><div class="text-5xl mb-3">â³</div><p>Chargement...</p></div>
                </div>
            </div>
        </div>

        <!-- Stats catÃ©gories -->
        <div class="bg-white rounded-2xl shadow-lg p-6 mt-6">
            <h2 class="text-xl font-bold text-gray-800 mb-5 text-right border-b pb-3">
                ğŸ“Š ØªÙˆØ²ÙŠØ¹ Ø§Ù„Ù…ØµØ±ÙˆÙØ§Øª Ø­Ø³Ø¨ Ø§Ù„ÙØ¦Ø©
                <span class="block text-sm font-normal text-gray-500 mt-1">RÃ©partition par catÃ©gorie</span>
            </h2>
            <div id="categoryStats" class="grid grid-cols-2 md:grid-cols-3 gap-4">
                <div class="text-center text-gray-400 col-span-full py-6">Aucune donnÃ©e</div>
            </div>
        </div>
    </div>

    <!-- Modal suppression -->
    <div id="deleteModal" class="fixed inset-0 bg-black/50 modal-overlay hidden z-50 flex items-center justify-center p-4">
        <div class="bg-white rounded-2xl shadow-2xl p-6 max-w-sm w-full">
            <div class="text-center mb-4">
                <div class="text-5xl mb-3">âš ï¸</div>
                <h3 class="text-xl font-bold text-gray-800">ØªØ£ÙƒÙŠØ¯ Ø§Ù„Ø­Ø°Ù</h3>
                <p class="text-gray-500 text-sm mt-2">Ù‡Ù„ Ø£Ù†Øª Ù…ØªØ£ÙƒØ¯ØŸ<br/>Confirmer la suppression ?</p>
            </div>
            <div class="flex gap-3">
                <button onclick="closeModal()" class="flex-1 py-2 border-2 border-gray-200 rounded-lg font-bold text-gray-600 hover:bg-gray-50">Ø¥Ù„ØºØ§Ø¡</button>
                <button onclick="confirmDelete()" class="flex-1 py-2 bg-red-500 hover:bg-red-600 text-white rounded-lg font-bold">Ø­Ø°Ù</button>
            </div>
        </div>
    </div>

    <footer class="bg-gray-800 text-white py-4 md:py-6 mt-auto">
        <div class="container mx-auto px-4 text-center text-xs md:text-sm text-gray-400">Â© 2026 Ø±Ø§Ø¨Ø·Ø© Ø´Ø¨Ø§Ø¨ Ø¬Ø¯Ø© - Administration</div>
    </footer>

    <script>
        const CATEGORIES = {
            administration: { label:'ğŸ¢ Administration', color:'#3b82f6', bg:'#eff6ff', text:'#1d4ed8' },
            evenement:      { label:'ğŸ‰ Ã‰vÃ©nement',      color:'#8b5cf6', bg:'#f5f3ff', text:'#6d28d9' },
            transport:      { label:'ğŸš— Transport',      color:'#f59e0b', bg:'#fffbeb', text:'#b45309' },
            restauration:   { label:'ğŸ½ï¸ Restauration',  color:'#ef4444', bg:'#fef2f2', text:'#dc2626' },
            materiel:       { label:'ğŸ› ï¸ MatÃ©riel',       color:'#10b981', bg:'#ecfdf5', text:'#065f46' },
            autre:          { label:'ğŸ“¦ Autre',           color:'#6b7280', bg:'#f9fafb', text:'#374151' },
        };

        let depenses = [];
        let totalCotisations = 0;
        let pendingDeleteId = null;

        document.getElementById('depenseDate').value = new Date().toISOString().split('T')[0];

        async function loadAll() {
            await Promise.all([loadCotisations(), loadDepenses()]);
        }

        async function loadCotisations() {
            try {
                const res = await fetch('/api/cotisations');
                const membres = await res.json();
                totalCotisations = membres.reduce((sum, m) => sum + m.paiements.length * m.montant, 0);
            } catch(e) { totalCotisations = 0; }
        }

        async function loadDepenses() {
            try {
                const res = await fetch('/api/depenses');
                depenses = await res.json();
            } catch(e) { depenses = []; }
            renderDepenses();
            updateBalance();
        }

        function updateBalance() {
            const totalDep = depenses.reduce((sum, d) => sum + Number(d.montant), 0);
            const solde    = totalCotisations - totalDep;
            const rate     = totalCotisations > 0 ? Math.round((totalDep / totalCotisations) * 100) : 0;

            document.getElementById('totalCotisations').textContent = totalCotisations.toLocaleString();
            document.getElementById('totalDepenses').textContent    = totalDep.toLocaleString();
            document.getElementById('solde').textContent            = solde.toLocaleString();
            document.getElementById('depenseRate').textContent      = rate + '%';

            const bar = document.getElementById('depenseProgressBar');
            bar.style.width = Math.min(rate, 100) + '%';
            if      (rate > 80) bar.className = 'h-full rounded-full progress-bar bg-gradient-to-r from-orange-400 to-red-500';
            else if (rate > 50) bar.className = 'h-full rounded-full progress-bar bg-gradient-to-r from-yellow-400 to-orange-400';
            else                bar.className = 'h-full rounded-full progress-bar bg-gradient-to-r from-green-400 to-yellow-400';

            document.getElementById('solde').className = solde < 0
                ? 'text-4xl font-extrabold text-red-300'
                : 'text-4xl font-extrabold text-yellow-300';

            renderCategoryStats();
        }

        async function addDepense() {
            const label    = document.getElementById('depenseLabel').value.trim();
            const montant  = parseFloat(document.getElementById('depenseMontant').value);
            const categorie= document.getElementById('depenseCategorie').value;
            const date     = document.getElementById('depenseDate').value;
            const note     = document.getElementById('depenseNote').value.trim();

            if (!label) {
                const el = document.getElementById('depenseLabel');
                el.classList.add('border-red-400'); el.focus();
                setTimeout(() => el.classList.remove('border-red-400'), 2000); return;
            }
            if (!montant || montant <= 0) {
                const el = document.getElementById('depenseMontant');
                el.classList.add('border-red-400'); el.focus();
                setTimeout(() => el.classList.remove('border-red-400'), 2000); return;
            }

            const btn = document.getElementById('saveBtn');
            btn.disabled = true;
            btn.textContent = 'â³ Enregistrement...';

            try {
                const res = await fetch('/api/depenses', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ label, montant, categorie, date, note })
                });
                const data = await res.json();
                if (!data.success) throw new Error();

                document.getElementById('depenseLabel').value   = '';
                document.getElementById('depenseMontant').value = '';
                document.getElementById('depenseNote').value    = '';
                document.getElementById('depenseDate').value    = new Date().toISOString().split('T')[0];

                await loadDepenses();
            } catch(e) { alert('âŒ Erreur lors de l\'enregistrement !'); }

            btn.disabled = false;
            btn.textContent = 'âœ… ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ù…ØµØ±ÙˆÙ / Enregistrer';
        }

        function deleteDepense(id) {
            pendingDeleteId = id;
            document.getElementById('deleteModal').classList.remove('hidden');
        }
        function closeModal() {
            pendingDeleteId = null;
            document.getElementById('deleteModal').classList.add('hidden');
        }
        async function confirmDelete() {
            if (pendingDeleteId !== null) {
                try {
                    await fetch(`/api/depenses/${pendingDeleteId}`, { method: 'DELETE' });
                    await loadDepenses();
                } catch(e) { alert('âŒ Erreur de suppression !'); }
            }
            closeModal();
        }
        async function clearAll() {
            if (!depenses.length) return;
            if (!confirm('ØªØ£ÙƒÙŠØ¯ Ø­Ø°Ù Ø¬Ù…ÙŠØ¹ Ø§Ù„Ù…ØµØ±ÙˆÙØ§ØªØŸ')) return;
            try {
                await Promise.all(depenses.map(d => fetch(`/api/depenses/${d.id}`, { method: 'DELETE' })));
                await loadDepenses();
            } catch(e) { alert('âŒ Erreur !'); }
        }

        function renderDepenses() {
            const container = document.getElementById('depensesList');
            const filterCat = document.getElementById('filterCategorie').value;
            const filtered  = filterCat ? depenses.filter(d => d.categorie === filterCat) : depenses;

            if (!filtered.length) {
                container.innerHTML = `<div class="text-center text-gray-400 py-8"><div class="text-5xl mb-3">ğŸ’¸</div><p class="font-medium">Ù„Ø§ ØªÙˆØ¬Ø¯ Ù…ØµØ±ÙˆÙØ§Øª</p><p class="text-sm">Aucune dÃ©pense enregistrÃ©e</p></div>`;
                return;
            }

            container.innerHTML = filtered.map(d => {
                const cat = CATEGORIES[d.categorie] || CATEGORIES.autre;
                const dateStr = d.date ? new Date(d.date).toLocaleDateString('fr-FR', { day:'2-digit', month:'short', year:'numeric' }) : '';
                return `
                <div class="expense-card flex items-center gap-3 p-3 rounded-xl border border-gray-100 bg-white" style="border-right:4px solid ${cat.color}">
                    <button onclick="deleteDepense(${d.id})" class="delete-btn text-red-300 hover:text-red-500 flex-shrink-0 p-1">
                        <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16"/>
                        </svg>
                    </button>
                    <div class="flex-grow text-right min-w-0">
                        <div class="flex items-center gap-2 justify-end flex-wrap">
                            <span class="text-xs px-2 py-0.5 rounded-full font-medium" style="background:${cat.bg};color:${cat.text}">${cat.label}</span>
                            <p class="font-bold text-gray-800 truncate">${d.label}</p>
                        </div>
                        ${d.note ? `<p class="text-xs text-gray-400 mt-0.5 truncate">${d.note}</p>` : ''}
                        <p class="text-xs text-gray-400 mt-0.5">${dateStr}</p>
                    </div>
                    <div class="text-right flex-shrink-0">
                        <p class="font-extrabold text-red-500 text-lg">${Number(d.montant).toLocaleString()}</p>
                        <p class="text-xs text-gray-400">MRO</p>
                    </div>
                </div>`;
            }).join('');
        }

        function renderCategoryStats() {
            const container = document.getElementById('categoryStats');
            const totalDep  = depenses.reduce((sum, d) => sum + Number(d.montant), 0);
            if (!totalDep) {
                container.innerHTML = '<div class="text-center text-gray-400 col-span-full py-6">Aucune donnÃ©e</div>';
                return;
            }
            const byCategory = {};
            depenses.forEach(d => { byCategory[d.categorie] = (byCategory[d.categorie] || 0) + Number(d.montant); });
            container.innerHTML = Object.entries(byCategory).sort((a,b) => b[1]-a[1]).map(([cat, total]) => {
                const c = CATEGORIES[cat] || CATEGORIES.autre;
                const percent = Math.round((total / totalDep) * 100);
                return `
                <div class="rounded-xl p-4 text-right" style="background:${c.bg};border:1px solid ${c.color}20">
                    <p class="text-sm font-bold mb-1" style="color:${c.text}">${c.label}</p>
                    <p class="text-2xl font-extrabold text-gray-800">${total.toLocaleString()}</p>
                    <p class="text-xs text-gray-500">MRO â€” ${percent}%</p>
                    <div class="mt-2 bg-white/60 rounded-full h-2 overflow-hidden">
                        <div class="h-full rounded-full" style="width:${percent}%;background:${c.color}"></div>
                    </div>
                </div>`;
            }).join('');
        }

        document.getElementById('depenseMontant').addEventListener('keydown', e => { if(e.key==='Enter') addDepense(); });
        document.getElementById('deleteModal').addEventListener('click', function(e) { if(e.target===this) closeModal(); });

        loadAll();
    </script>
</body>
</html>